<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jerome Boyer"><link href=../ecs/ rel=prev><link href=../msk/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.33"><title>EKS - AWS Studies</title><link rel=stylesheet href=../../assets/stylesheets/main.3cba04c6.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#elastic-kubernetes-service class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="AWS Studies" class="md-header__button md-logo" aria-label="AWS Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AWS Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> EKS </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/yarfba.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="AWS Studies" class="md-nav__button md-logo" aria-label="AWS Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> AWS Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/yarfba.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Infrastructure </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../infra/ class=md-nav__link> <span class=md-ellipsis> EC2-others </span> </a> </li> <li class=md-nav__item> <a href=../../infra/networking/ class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> <li class=md-nav__item> <a href=../../infra/security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> <li class=md-nav__item> <a href=../../infra/storage/ class=md-nav__link> <span class=md-ellipsis> S3-Storage </span> </a> </li> <li class=md-nav__item> <a href=../../infra/route53/ class=md-nav__link> <span class=md-ellipsis> Route 53 </span> </a> </li> <li class=md-nav__item> <a href=../../monitoring/monitoring/ class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../../monitoring/cost/ class=md-nav__link> <span class=md-ellipsis> Cost mgt </span> </a> </li> <li class=md-nav__item> <a href=../../kinesis/ class=md-nav__link> <span class=md-ellipsis> Kinesis* </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../sa/well-architectured/ class=md-nav__link> <span class=md-ellipsis> Well Architectured </span> </a> </li> <li class=md-nav__item> <a href=../../sa/sol-design/ class=md-nav__link> <span class=md-ellipsis> Solution design </span> </a> </li> <li class=md-nav__item> <a href=../../sa/psa-role/ class=md-nav__link> <span class=md-ellipsis> SA </span> </a> </li> <li class=md-nav__item> <a href=../../sa/saas/ class=md-nav__link> <span class=md-ellipsis> SaaS </span> </a> </li> <li class=md-nav__item> <a href=../../sa/resiliency/ class=md-nav__link> <span class=md-ellipsis> Resiliency </span> </a> </li> <li class=md-nav__item> <a href=../../templ/ class=md-nav__link> <span class=md-ellipsis> Conduct Design session </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Analytics </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Analytics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../analytics/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../analytics/emr/ class=md-nav__link> <span class=md-ellipsis> EMR </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../data/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../data/rds/ class=md-nav__link> <span class=md-ellipsis> RDS-Aurora </span> </a> </li> <li class=md-nav__item> <a href=../../data/dynamodb/ class=md-nav__link> <span class=md-ellipsis> DynamoDB </span> </a> </li> <li class=md-nav__item> <a href=../../data/data-lake/ class=md-nav__link> <span class=md-ellipsis> Data Lake </span> </a> </li> <li class=md-nav__item> <a href=../../data/redshift/ class=md-nav__link> <span class=md-ellipsis> RedShift </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> AI-ML </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> AI-ML </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ai-ml/ class=md-nav__link> <span class=md-ellipsis> All Services </span> </a> </li> <li class=md-nav__item> <a href=../../ai-ml/sagemaker/ class=md-nav__link> <span class=md-ellipsis> SageMaker </span> </a> </li> <li class=md-nav__item> <a href=../../ai-ml/bedrock/ class=md-nav__link> <span class=md-ellipsis> Bedrock </span> </a> </li> <li class=md-nav__item> <a href=../../ai-ml/q/ class=md-nav__link> <span class=md-ellipsis> Amazon Q </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Serverless </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Serverless </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../lambda/ class=md-nav__link> <span class=md-ellipsis> Lambda </span> </a> </li> <li class=md-nav__item> <a href=../apigtw/ class=md-nav__link> <span class=md-ellipsis> API Gateway </span> </a> </li> <li class=md-nav__item> <a href=../ecs/ class=md-nav__link> <span class=md-ellipsis> ECS </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> EKS </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> EKS </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#major-characteristics class=md-nav__link> <span class=md-ellipsis> Major characteristics </span> </a> </li> <li class=md-nav__item> <a href=#cluster-management class=md-nav__link> <span class=md-ellipsis> Cluster management </span> </a> <nav class=md-nav aria-label="Cluster management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iam-role-for-service-account class=md-nav__link> <span class=md-ellipsis> IAM role for service account </span> </a> </li> <li class=md-nav__item> <a href=#fargate-profile class=md-nav__link> <span class=md-ellipsis> Fargate profile </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ecs-comparisons class=md-nav__link> <span class=md-ellipsis> ECS comparisons </span> </a> </li> <li class=md-nav__item> <a href=#what-to-do-the-first-time class=md-nav__link> <span class=md-ellipsis> What to do the first time </span> </a> </li> <li class=md-nav__item> <a href=#working-with-cluster class=md-nav__link> <span class=md-ellipsis> Working with cluster </span> </a> <nav class=md-nav aria-label="Working with cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#eksctl-approach class=md-nav__link> <span class=md-ellipsis> eksctl approach </span> </a> </li> <li class=md-nav__item> <a href=#delete-cluster class=md-nav__link> <span class=md-ellipsis> Delete cluster </span> </a> </li> <li class=md-nav__item> <a href=#eks-with-fargate-node-using-cdk class=md-nav__link> <span class=md-ellipsis> EKS with Fargate node using CDK </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#eks-blueprint class=md-nav__link> <span class=md-ellipsis> EKS Blueprint </span> </a> <nav class=md-nav aria-label="EKS Blueprint"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#concepts class=md-nav__link> <span class=md-ellipsis> Concepts </span> </a> </li> <li class=md-nav__item> <a href=#eks-with-cdk-hands-on class=md-nav__link> <span class=md-ellipsis> EKS with CDK Hands-on </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#autoscaling-the-cluster class=md-nav__link> <span class=md-ellipsis> Autoscaling the cluster </span> </a> </li> <li class=md-nav__item> <a href=#deeper-dive class=md-nav__link> <span class=md-ellipsis> Deeper Dive </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study class=md-nav__link> <span class=md-ellipsis> Messaging </span> </a> </li> <li class=md-nav__item> <a href=../msk/ class=md-nav__link> <span class=md-ellipsis> MSK </span> </a> </li> <li class=md-nav__item> <a href=../../kinesis/ class=md-nav__link> <span class=md-ellipsis> Kinesis* </span> </a> </li> <li class=md-nav__item> <a href=../eventbridge/ class=md-nav__link> <span class=md-ellipsis> EventBridge </span> </a> </li> <li class=md-nav__item> <a href=../stepfct/ class=md-nav__link> <span class=md-ellipsis> Step function </span> </a> </li> <li class=md-nav__item> <a href=../mwaa/ class=md-nav__link> <span class=md-ellipsis> MWAA </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Playground </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Playground </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../playground/ class=md-nav__link> <span class=md-ellipsis> AWS personal labs </span> </a> </li> <li class=md-nav__item> <a href=../../playground/gettingstarted/ class=md-nav__link> <span class=md-ellipsis> Getting Started EC2 </span> </a> </li> <li class=md-nav__item> <a href=../../playground/security/ class=md-nav__link> <span class=md-ellipsis> Security-IAM demos </span> </a> </li> <li class=md-nav__item> <a href=../../playground/s3-play/ class=md-nav__link> <span class=md-ellipsis> S3 play </span> </a> </li> <li class=md-nav__item> <a href=../../playground/networking/ class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> <li class=md-nav__item> <a href=../../playground/rds/ class=md-nav__link> <span class=md-ellipsis> RDS </span> </a> </li> <li class=md-nav__item> <a href=../../playground/rt-data-processing/ class=md-nav__link> <span class=md-ellipsis> Data processing </span> </a> </li> <li class=md-nav__item> <a href=../../playground/spark-emr/ class=md-nav__link> <span class=md-ellipsis> Analytics on EMR </span> </a> </li> <li class=md-nav__item> <a href=../../playground/ecs/ class=md-nav__link> <span class=md-ellipsis> ECS </span> </a> </li> <li class=md-nav__item> <a href=../../playground/s3-org-billing/ class=md-nav__link> <span class=md-ellipsis> S3 storage lens </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/big-data-tenant-analytics/ class=md-nav__link> <span class=md-ellipsis> SaaS demo </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> Coding </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../coding/ class=md-nav__link> <span class=md-ellipsis> Practices </span> </a> </li> <li class=md-nav__item> <a href=../../coding/sam/ class=md-nav__link> <span class=md-ellipsis> SAM </span> </a> </li> <li class=md-nav__item> <a href=../../coding/cloudFormation/ class=md-nav__link> <span class=md-ellipsis> CloudFormation </span> </a> </li> <li class=md-nav__item> <a href=../../coding/cdk/ class=md-nav__link> <span class=md-ellipsis> CDK </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io class=md-nav__link> <span class=md-ellipsis> Return to main </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#major-characteristics class=md-nav__link> <span class=md-ellipsis> Major characteristics </span> </a> </li> <li class=md-nav__item> <a href=#cluster-management class=md-nav__link> <span class=md-ellipsis> Cluster management </span> </a> <nav class=md-nav aria-label="Cluster management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iam-role-for-service-account class=md-nav__link> <span class=md-ellipsis> IAM role for service account </span> </a> </li> <li class=md-nav__item> <a href=#fargate-profile class=md-nav__link> <span class=md-ellipsis> Fargate profile </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ecs-comparisons class=md-nav__link> <span class=md-ellipsis> ECS comparisons </span> </a> </li> <li class=md-nav__item> <a href=#what-to-do-the-first-time class=md-nav__link> <span class=md-ellipsis> What to do the first time </span> </a> </li> <li class=md-nav__item> <a href=#working-with-cluster class=md-nav__link> <span class=md-ellipsis> Working with cluster </span> </a> <nav class=md-nav aria-label="Working with cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#eksctl-approach class=md-nav__link> <span class=md-ellipsis> eksctl approach </span> </a> </li> <li class=md-nav__item> <a href=#delete-cluster class=md-nav__link> <span class=md-ellipsis> Delete cluster </span> </a> </li> <li class=md-nav__item> <a href=#eks-with-fargate-node-using-cdk class=md-nav__link> <span class=md-ellipsis> EKS with Fargate node using CDK </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#eks-blueprint class=md-nav__link> <span class=md-ellipsis> EKS Blueprint </span> </a> <nav class=md-nav aria-label="EKS Blueprint"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#concepts class=md-nav__link> <span class=md-ellipsis> Concepts </span> </a> </li> <li class=md-nav__item> <a href=#eks-with-cdk-hands-on class=md-nav__link> <span class=md-ellipsis> EKS with CDK Hands-on </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#autoscaling-the-cluster class=md-nav__link> <span class=md-ellipsis> Autoscaling the cluster </span> </a> </li> <li class=md-nav__item> <a href=#deeper-dive class=md-nav__link> <span class=md-ellipsis> Deeper Dive </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=elastic-kubernetes-service><a href=https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html>Elastic Kubernetes Service</a><a class=headerlink href=#elastic-kubernetes-service title="Permanent link">&para;</a></h1> <div class="admonition -"> <p class=admonition-title>Info</p> <p>Updated 9/12/2023</p> </div> <p><a href=https://aws.amazon.com/eks/ >Amazon EKS</a> is a fully managed service to run Kubernetes. It is highly available, AWS manages the control plane, and user defines the worker nodes and then the workloads deployed:</p> <p><img alt src=../diagrams/eks/eks-ec2.drawio.svg></p> <ul> <li>There are 3 public subnets and 3 private subnets to be created across 3 availability zones and we provision the EKS node group in the private subnets and it communicates with the EKS control plane through the private cluster mode by using the private endpoint.</li> <li>Because the Pods inside the private EKS cluster might have to access the internet resources so we shall setup the NAT gateway in the public subnets.</li> <li>Application Load Balancer is used as the ingress to route the traffic for the deployed application in private subnets, and only ALB can access EKS cluster by referencing the ALB security group from EKS data plane security group. It is integrated with VPC for isolation, IAM for authentication, ELB for load distribution, and ECR for container image registry.</li> <li>Worker nodes can be EC2 instances in a <code>Managed Node Group</code> (EKS managed) or Fargate worker nodes as part of <code>Fargate profile</code>.</li> </ul> <h2 id=major-characteristics>Major characteristics<a class=headerlink href=#major-characteristics title="Permanent link">&para;</a></h2> <ul> <li> <p>Scale K8s control plane across multiple AZs.</p> <p><img alt src=../diagrams/eks/eks-control-plane.drawio.png></p> </li> <li> <p>No need to install, operate and maintain k8s cluster.</p> </li> <li>Automatically scales control plane instances based on load, detects and replaces unhealthy control plane instance.</li> <li>It supports EC2 as worker nodes or Fargate to deploy serverless containers or <a href=../../infra/#aws-outposts>nodes in AWS Outposts</a>.</li> <li>Fully compatible with other CNSF kubernetes.</li> <li>Can be deployed on-premises with <a href=https://distro.eks.amazonaws.com/ >Amazon EKS Distro (EKS-D)</a> distribution.</li> </ul> <p>The EKS node types are:</p> <ul> <li> <p><strong>Managed node groups</strong>: to automate the provisioning and lifecycle management of EC2 (could be On-demand or spot instances). Nodes run using the latest Amazon EKS optimized AMIs. This is the recommended way to allocate capacity. EC2 are managed by AWS and assigned to a ASG managed by EKS. Nodes are tagged for auto-discovery by k8s cluster autoscaler. Can configure <code>Launch template</code> to be used with custom AMI or with custom user data. </p> <p>The following figure illustrates a classical multi-AZ, one ASG/MMG deployment for stateless applications.</p> <p><img alt src=../diagrams/eks/mmg-stateless.drawio.png></p> <p>While for stateful apps, we need to consider one MMG/ASG per AZ.</p> <p><img alt src=../diagrams/eks/mmg-stateful.drawio.png></p> </li> <li> <p><strong>Self-managed nodes</strong>: nodes are managed by the user and attached to EKS cluster by using an ASG. User uses his own AMI-based EC2 instances that are part of the auto-scaling group and will serve as worker nodes for the cluster. Spot instances can be used to reduce cost.</p> </li> <li><strong>AWS Fargate</strong> which represents a cost optimized deployment for EKS worker nodes. Each time a pod is created it is assigned to an existing EC2 instance and runs within a microVM. It works with ALB.</li> </ul> <p>Data volumes (EBS, EFS, FSx) are defined with StorageClass and they need to have Container Storage Interface compliant driver.</p> <p>See <a href=https://aws.amazon.com/eks/pricing/ >Pricing calculator</a>: pay for cluster control plane, EC2 instances, Fargate or AWS outposts.</p> <h2 id=cluster-management>Cluster management<a class=headerlink href=#cluster-management title="Permanent link">&para;</a></h2> <ul> <li>EKS runs a single tenant Kubernetes control plane for each cluster. 3 <code>etcd</code> instances in 3 AZs within one region.</li> <li>A set of add-ons are defined by default: CoreDNS, kube-proxy, VPC CNI. Others can be added like metrics server, cluster autoscaler, EFS CSI driver, EBS CSI driver, <a href=https://fluentbit.io/ >fluentbit</a> (logging and metrics processor and forwarder).</li> <li>EKS uses IAM to provide authentication to the Kubernetes cluster, and k8s RBAC for authorization.</li> <li>EKS hosts a public OIDC discovery endpoint per cluster containing the signing keys for the <code>ProjectedServiceAccountToken</code> JSON web tokens so external systems, like IAM, can validate and accept the Kubernetes-issued OIDC tokens. OIDC federation access allows user or app to assume IAM roles via the Secure Token Service (STS), enabling authentication with an OIDC provider, receiving a JSON Web Token (JWT), which in turn can be used to assume an IAM role.</li> </ul> <h3 id=iam-role-for-service-account>IAM role for service account<a class=headerlink href=#iam-role-for-service-account title="Permanent link">&para;</a></h3> <p>IAM role for service account helps to define role for pods and not the EC2 running the pods. This is a fine grained access control.</p> <p>To use IAM roles for service accounts in the cluster, we must create an IAM OIDC Identity Provider. </p> <h3 id=fargate-profile><a href=https://docs.aws.amazon.com/eks/latest/userguide/fargate-profile.html>Fargate profile</a><a class=headerlink href=#fargate-profile title="Permanent link">&para;</a></h3> <p>A fargate profile specifies which pods use Fargate. EKS uses special controller to schedule pods to Fargate. Pods must match a Fargate profile at the time that they're scheduled to run on Fargate. They run only on private subnets. Each pod is isolated within a microVM (<a href=https://firecracker-microvm.github.io/ >Firecrakers</a>).</p> <h2 id=ecs-comparisons>ECS comparisons<a class=headerlink href=#ecs-comparisons title="Permanent link">&para;</a></h2> <ul> <li>An EC2 instance with the ECS agent installed and configured is called a container instance. In Amazon EKS, it is called a worker node.</li> <li>An ECS container is called a task. In Amazon EKS, it is called a pod.</li> <li>While Amazon ECS runs on AWS native technology, Amazon EKS runs Kubernetes.</li> <li>ECS scale at thousand of tasks, EKS is still limited in number of nodes and total pods.</li> </ul> <h2 id=what-to-do-the-first-time>What to do the first time<a class=headerlink href=#what-to-do-the-first-time title="Permanent link">&para;</a></h2> <ol> <li> <p><a href=https://www.eksworkshop.com/020_prerequisites/k8stools/ >Install kubernetes tools</a> like <code>kubectl</code> and AWS CLI:</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>curl<span class=w> </span>--silent<span class=w> </span>--location<span class=w> </span>-o<span class=w> </span>/usr/local/bin/kubectl<span class=w> </span>https://s3.us-west-2.amazonaws.com/amazon-eks/1.23.7/2022-06-29/bin/linux/amd64/kubectl

sudo<span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/usr/local/bin/kubectl

curl<span class=w> </span><span class=s2>&quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot;</span><span class=w> </span>-o<span class=w> </span><span class=s2>&quot;awscliv2.zip&quot;</span>
unzip<span class=w> </span>awscliv2.zip
sudo<span class=w> </span>./aws/install
</code></pre></div> </li> <li> <p>Install jq, gettext...</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>yum<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>jq<span class=w> </span>gettext<span class=w> </span>bash-completion<span class=w> </span>moreutils
<span class=c1># Verify the path</span>
<span class=k>for</span><span class=w> </span><span class=nb>command</span><span class=w> </span><span class=k>in</span><span class=w> </span>kubectl<span class=w> </span>jq<span class=w> </span>envsubst<span class=w> </span>aws
<span class=k>do</span>
<span class=w>    </span>which<span class=w> </span><span class=nv>$command</span><span class=w> </span><span class=p>&amp;</span>&gt;/dev/null<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;</span><span class=nv>$command</span><span class=s2> in path&quot;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;</span><span class=nv>$command</span><span class=s2> NOT FOUND&quot;</span>
<span class=k>done</span>

<span class=c1># Enable kubectl bash_completion</span>
kubectl<span class=w> </span>completion<span class=w> </span>bash<span class=w> </span>&gt;&gt;<span class=w>  </span>~/.bash_completion
.<span class=w> </span>/etc/profile.d/bash_completion.sh
.<span class=w> </span>~/.bash_completion
</code></pre></div> </li> <li> <p>Download <code>eksctl</code> (<a href=https://github.com/weaveworks/eksctl>eksctl.io</a>). (It also installs <code>kubectl</code>)</p> <div class=highlight><pre><span></span><code>brew<span class=w> </span>tap<span class=w> </span>weaveworks/tap
brew<span class=w> </span>install<span class=w> </span>weaveworks/tap/eksctl
<span class=c1># Verify it</span>
eksctl<span class=w> </span>version
</code></pre></div> </li> <li> <p>Create IAM Role and attach the required Amazon EKS IAM managed policy to it. Kubernetes clusters managed by Amazon EKS make calls to other AWS services on our behalf to manage the resources that we use with the service.</p> <div class=highlight><pre><span></span><code><span class=c1># under the  labs/eks folder</span>
aws<span class=w> </span>iam<span class=w> </span>create-role<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--role-name<span class=w> </span>myAmazonEKSClusterRole<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--assume-role-policy-document<span class=w> </span>file://<span class=s2>&quot;eks-cluster-role-trust-policy.json&quot;</span>
<span class=c1># Attach the required Amazon EKS managed IAM policy to the role.</span>
aws<span class=w> </span>iam<span class=w> </span>attach-role-policy<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--policy-arn<span class=w> </span>arn:aws:iam::aws:policy/AmazonEKSClusterPolicy<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--role-name<span class=w> </span>myAmazonEKSClusterRole
</code></pre></div> </li> </ol> <h2 id=working-with-cluster>Working with cluster<a class=headerlink href=#working-with-cluster title="Permanent link">&para;</a></h2> <p>To create an EKS cluster with EC2 or Fargate, within its own VPC, in private subnets, with security groups, we can use different approaches:</p> <ul> <li>AWS Console.</li> <li>Using <code>eksctl</code> command line and a yaml config file defining the cluster.</li> <li>CDK to create the infrastructure and then EKS cluster itself. See examples in <a href=https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_eks-readme.html#quick-start>the product doc</a>, see also a CDK example in <code>labs/cdk/eks-single</code> folder or the <code>labs/eks/eks-cdk</code> folder for a python based deployment.</li> <li>Using CloudFormation for the VPC infrastructure with a predefined stack.</li> </ul> <h3 id=eksctl-approach>eksctl approach<a class=headerlink href=#eksctl-approach title="Permanent link">&para;</a></h3> <p>Based on the <a href=https://www.eksworkshop.com/ >EKS workshop</a>), using Cloud9, quick summary of steps:</p> <ol> <li><a href=https://www.eksworkshop.com/020_prerequisites/workspace/ >Create workspace in Cloud9</a> and install dependencies (See previous <a href=#what-to-do-the-first-time>section</a>).</li> <li>Create IAM role named <code>eks-admin</code> with AdministratorAccess, and modify the Cloud9, EC2 instance IAM role using: <code>Actions &gt; Security &gt; Modify IAM Role.</code></li> <li>Update Cloud9 workspace to disable Cloud9 to manage IAM credentials dynamically (This is not compatible with the EKS IAM authentication). <code>Gear &gt; AWS Settings &gt;</code> . </li> <li> <p>Save region and account as env variable and configure aws CLI:</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;export ACCOUNT_ID=</span><span class=si>${</span><span class=nv>ACCOUNT_ID</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>tee<span class=w> </span>-a<span class=w> </span>~/.bash_profile
<span class=nb>echo</span><span class=w> </span><span class=s2>&quot;export AWS_REGION=</span><span class=si>${</span><span class=nv>AWS_REGION</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>tee<span class=w> </span>-a<span class=w> </span>~/.bash_profile
aws<span class=w> </span>configure<span class=w> </span><span class=nb>set</span><span class=w> </span>default.region<span class=w> </span><span class=si>${</span><span class=nv>AWS_REGION</span><span class=si>}</span>
aws<span class=w> </span>configure<span class=w> </span>get<span class=w> </span>default.region

<span class=c1># validate that the Cloud9 IDE is using the correct IAM role</span>
aws<span class=w> </span>sts<span class=w> </span>get-caller-identity<span class=w> </span>--query<span class=w> </span>Arn<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>eks-admin<span class=w> </span>-q<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;IAM role valid&quot;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;IAM role NOT valid&quot;</span>
</code></pre></div> </li> <li> <p>Use <code>eksctl create cluster</code> which creates CloudFormation to deploy a EKS cluster with managed nodes:</p> <div class=highlight><pre><span></span><code>eksctl<span class=w> </span>create<span class=w> </span>cluster<span class=w> </span>-f<span class=w> </span>eks-cluster.yaml
</code></pre></div> <p>See the schema <a href=https://eksctl.io/usage/schema/ >definition here</a>.</p> <p>Find the cluster credentials added to <code>~/.kube/config</code></p> </li> <li> <p>Update kubeconfig to interact with the cluster</p> <div class=highlight><pre><span></span><code>aws<span class=w> </span>eks<span class=w> </span>update-kubeconfig<span class=w> </span>--name<span class=w> </span>MyEKS<span class=w> </span>--region<span class=w> </span><span class=si>${</span><span class=nv>AWS_REGION</span><span class=si>}</span>
</code></pre></div> </li> <li> <p>Verify kubectl works with the cluster</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>nodes
</code></pre></div> </li> <li> <p>Export worker role name</p> <div class=highlight><pre><span></span><code><span class=nv>STACK_NAME</span><span class=o>=</span><span class=k>$(</span>eksctl<span class=w> </span>get<span class=w> </span>nodegroup<span class=w> </span>--cluster<span class=w> </span>myeks<span class=w> </span>-o<span class=w> </span>json<span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>-r<span class=w> </span><span class=s1>&#39;.[].StackName&#39;</span><span class=k>)</span>
<span class=nv>ROLE_NAME</span><span class=o>=</span><span class=k>$(</span>aws<span class=w> </span>cloudformation<span class=w> </span>describe-stack-resources<span class=w> </span>--stack-name<span class=w> </span><span class=nv>$STACK_NAME</span><span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>-r<span class=w> </span><span class=s1>&#39;.StackResources[] | select(.ResourceType==&quot;AWS::IAM::Role&quot;) | .PhysicalResourceId&#39;</span><span class=k>)</span>
<span class=nb>echo</span><span class=w> </span><span class=s2>&quot;export ROLE_NAME=</span><span class=si>${</span><span class=nv>ROLE_NAME</span><span class=si>}</span><span class=s2>&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>tee<span class=w> </span>-a<span class=w> </span>~/.bash_profile
</code></pre></div> </li> <li> <p>Create an eks-admin service account and cluster role binding</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>eks-admin-service-account.yaml
</code></pre></div> </li> <li> <p>Deploy Prometheus (be sure to have helm cli)</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>create<span class=w> </span>namespace<span class=w> </span>prometheus
helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>prometheus-community<span class=w> </span>https://prometheus-community.github.io/helm-charts
helm<span class=w> </span>upgrade<span class=w> </span>-i<span class=w> </span>prometheus<span class=w> </span>prometheus-community/prometheus<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--namespace<span class=w> </span>prometheus<span class=w> </span><span class=se>\</span>
<span class=w>    </span>--set<span class=w> </span>alertmanager.persistentVolume.storageClass<span class=o>=</span><span class=s2>&quot;gp2&quot;</span>,server.persistentVolume.storageClass<span class=o>=</span><span class=s2>&quot;gp2&quot;</span>
kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>prometheus
</code></pre></div> <p>To access Prometheus web app: <code>kubectl --namespace=prometheus port-forward deploy/prometheus-server 8080:9090</code> </p> </li> <li> <p>For administration, deploy Kubernetes dashboard:</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
<span class=c1># Connect to the dashboard by first getting the admin user secret</span>
kubectl<span class=w> </span>-n<span class=w> </span>kube-system<span class=w> </span>describe<span class=w> </span>secret<span class=w> </span><span class=k>$(</span>kubectl<span class=w> </span>-n<span class=w> </span>kube-system<span class=w> </span>get<span class=w> </span>secret<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>eks-admin<span class=w> </span><span class=p>|</span><span class=w> </span>awk<span class=w> </span><span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
<span class=c1># the following could also be used</span>
aws<span class=w> </span>eks<span class=w> </span>get-token<span class=w> </span>--cluster-name<span class=w> </span>myeks<span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>-r<span class=w> </span><span class=s1>&#39;.status.token&#39;</span>
<span class=c1># Then local proxy</span>
kubectl<span class=w> </span>proxy<span class=w> </span>--port<span class=o>=</span><span class=m>8080</span><span class=w> </span>--disable-filter<span class=o>=</span><span class=nb>true</span>
<span class=c1># append the api to the exported URL:  api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/?#!/login</span>
</code></pre></div> </li> <li> <p>For monitoring, it is interesting to deploy <strong>AWS Distro for OpenTelemetry</strong> to collect metric logs to AWS CloudWatch, and <code>Container Insight</code> feature of CW to see application performance. Deploy the AWS Distro for OpenTelemetry collector as a DaemonSet by entering the following command.</p> <div class=highlight><pre><span></span><code>curl<span class=w> </span>https://raw.githubusercontent.com/aws-observability/aws-otel-collector/main/deployment-template/eks/otel-container-insights-infra.yaml<span class=w> </span><span class=p>|</span>
kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span>
<span class=c1># Verify the running pods</span>
kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-l<span class=w> </span><span class=nv>name</span><span class=o>=</span>aws-otel-eks-ci<span class=w> </span>-n<span class=w> </span>aws-otel-eks
</code></pre></div> <p><em>After a few mins, the CloudWatch Logs Group should have 3 logs groups created by the OTEL DaemonSet.</em></p> </li> <li> <p>Verify nodes and pods</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>nodes<span class=w> </span>-o<span class=w> </span>wide
<span class=c1># across namespaces</span>
kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>wide
</code></pre></div> </li> <li> <p>Deploy an application using deployment, services and a service account. It is important to use the concept of iam role to service account mapping to control what AWS services the pod is able to access instead of using iam role and policies set at the EC2 level, as all pods within the EC2 will have the same policies. Applying the least permission.</p> </li> <li> <p>Expose the application to the internet.</p> <p>To do so we need to deploy the AWS Load Balancer controller inside the EKS cluster. Using Helm we can do:</p> <div class=highlight><pre><span></span><code>helm<span class=w> </span>repo<span class=w> </span>add<span class=w> </span>eks<span class=w> </span>https://aws.github.io/eks-charts
<span class=c1># Install the TargetGroupBinding CRDs</span>
kubectl<span class=w> </span>apply<span class=w> </span>-k<span class=w> </span><span class=s2>&quot;github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master&quot;</span>
<span class=c1># install controller</span>
helm<span class=w> </span>install<span class=w> </span>aws-load-balancer-controller<span class=w> </span>eks/aws-load-balancer-controller<span class=w> </span>-n<span class=w> </span>kube-system<span class=w> </span>--set<span class=w> </span><span class=nv>clusterName</span><span class=o>=</span>web-host-on-eks<span class=w> </span>--set<span class=w> </span>serviceAccount.create<span class=o>=</span><span class=nb>false</span><span class=w> </span>--set<span class=w> </span>serviceAccount.name<span class=o>=</span>aws-load-balancer-controller
</code></pre></div> </li> </ol> <h3 id=delete-cluster>Delete cluster<a class=headerlink href=#delete-cluster title="Permanent link">&para;</a></h3> <ul> <li>List all services</li> </ul> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>svc<span class=w> </span>--all-namespaces
</code></pre></div> <ul> <li>Delete any services that have an associated EXTERNAL-IP value. These services are fronted by an ELB load balancer, and we must delete them in Kubernetes to allow the load balancer and associated resources to be properly released.</li> </ul> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>delete<span class=w> </span>svc<span class=w> </span>&lt;service-name&gt;
</code></pre></div> <ul> <li>Delete the cluster</li> </ul> <div class=highlight><pre><span></span><code>eksctl<span class=w> </span>delete<span class=w> </span>cluster<span class=w> </span>--name<span class=w> </span>&lt;cluster<span class=w> </span>name&gt;
</code></pre></div> <h3 id=eks-with-fargate-node-using-cdk>EKS with Fargate node using CDK<a class=headerlink href=#eks-with-fargate-node-using-cdk title="Permanent link">&para;</a></h3> <p>AWS Fargate is a technology that provides on-demand, right-sized compute capacity for containers. We control which pods start on Fargate and how they run with Fargate Profiles.</p> <ul> <li><a href=https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html>See instructions EKS fargate getting started</a>.</li> <li>Fargate profiles are associated to namespaces.</li> <li>Only private subnets are supported for pods that are running on Fargate.</li> <li>Pods that match a selector are scheduled on Fargate.</li> <li>Kubernetes affinity/anti-affinity rules do not apply and aren't necessary with Amazon EKS Fargate pod.</li> </ul> <p>Here is an example of CDK declaration for a Fargate Cluster. See the local CDK file in <code>labs/eks/cdk-fargate</code>:</p> <div class=highlight><pre><span></span><code><span class=c1># EKS cluster that only uses Fargate capacity</span>
 <span class=n>aws_eks</span><span class=o>.</span><span class=n>FargateCluster</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=s2>&quot;MyEKS&quot;</span><span class=p>,</span>
            <span class=n>version</span><span class=o>=</span><span class=n>aws_eks</span><span class=o>.</span><span class=n>KubernetesVersion</span><span class=o>.</span><span class=n>V1_24</span><span class=p>)</span>
</code></pre></div> <p>To add FargateProfile to an existing cluster:</p> <div class=highlight><pre><span></span><code><span class=n>cluster</span> <span class=o>=</span> <span class=n>aws_eks</span><span class=o>.</span><span class=n>Cluster</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;demo-cluster&#39;</span><span class=p>,</span>
                                  <span class=n>masters_role</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>eks_admin_role</span><span class=p>,</span>
                                  <span class=n>vpc</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>vpc</span><span class=p>,</span>
                                  <span class=n>default_capacity</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
                                  <span class=n>vpc_subnets</span><span class=o>=</span><span class=p>[</span><span class=n>aws_ec2</span><span class=o>.</span><span class=n>SubnetSelection</span><span class=p>(</span><span class=n>subnet_type</span><span class=o>=</span><span class=n>aws_ec2</span><span class=o>.</span><span class=n>SubnetType</span><span class=o>.</span><span class=n>PRIVATE_WITH_EGRESS</span><span class=p>)],</span>
                                  <span class=n>version</span><span class=o>=</span><span class=n>aws_eks</span><span class=o>.</span><span class=n>KubernetesVersion</span><span class=o>.</span><span class=n>V1_24</span><span class=p>,</span>
                                  <span class=n>output_cluster_name</span><span class=o>=</span><span class=kc>True</span>
                                  <span class=p>)</span>
<span class=n>cluster</span><span class=o>.</span><span class=n>add_fargate_profile</span><span class=p>(</span><span class=s2>&quot;MyProfile&quot;</span><span class=p>,</span>
    <span class=n>selectors</span><span class=o>=</span><span class=p>[</span><span class=n>eks</span><span class=o>.</span><span class=n>Selector</span><span class=p>(</span><span class=n>namespace</span><span class=o>=</span><span class=s2>&quot;default&quot;</span><span class=p>)]</span>
<span class=p>)</span>
</code></pre></div> <p>See <a href=https://docs.aws.amazon.com/cdk/api/v2/python/aws_cdk.aws_eks/README.html>Python cdk eks documentation.</a></p> <p>If we do not specify a VPC while defining the cluster, one will be created on our behalf, which we can then access via <code>cluster.vpc</code>.</p> <p>The fargate cluster declaration for example will create a CloudFormation template with:</p> <ul> <li>VPC, two public subnets, route table for each public subnet, with default route to internet gateway</li> <li>An internet gateway attached to the VPC</li> <li>Elastic Interface per public subnet</li> <li>NAT gateway for each public subnet</li> <li>Two private subnets, with route table and route with outbound to NAT gateway</li> <li>An IAM role to allow access to EKS principal with cluster access</li> <li>An IAM role to be able to create EKS cluster</li> <li>An IAM role for the EKS master admin user</li> <li>An IAM role for fargate pod execution</li> <li>Security group for the control plane</li> <li>A custom kubernetes resources for Authentication</li> </ul> <h2 id=eks-blueprint><a href=https://aws.amazon.com/blogs/containers/bootstrapping-clusters-with-eks-blueprints/ >EKS Blueprint</a><a class=headerlink href=#eks-blueprint title="Permanent link">&para;</a></h2> <p>The EKS Blueprints is an open-source development framework that abstracts the complexities of cloud infrastructure from developers.</p> <h3 id=concepts>Concepts<a class=headerlink href=#concepts title="Permanent link">&para;</a></h3> <ul> <li>A blueprint combines clusters, add-ons, and teams into a cohesive object that can be deployed as a whole.</li> <li>Team is a logical grouping of IAM identities that have access to a Kubernetes namespace(s), or cluster administrative access depending upon the team type.</li> <li>Once a blueprint is configured, it can be easily deployed across any number of AWS accounts and regions.</li> <li>Blueprints also leverage GitOps tooling to facilitate cluster bootstrapping and workload onboarding.</li> </ul> <p><img alt src=https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2022/04/18/eks-blueprints-ref-951x1024.png></p> <h3 id=eks-with-cdk-hands-on>EKS with CDK Hands-on<a class=headerlink href=#eks-with-cdk-hands-on title="Permanent link">&para;</a></h3> <p>This is a summary of the steps to get a running demonstration of creating EKS and Day 2 add-on.</p> <h4 id=single-cluster>Single Cluster<a class=headerlink href=#single-cluster title="Permanent link">&para;</a></h4> <ul> <li>Using CDK typescript here are the commands:</li> </ul> <div class=highlight><pre><span></span><code>mkdir<span class=w> </span>my-eks-blueprints
<span class=nb>cd</span><span class=w> </span>my-eks-blueprints
cdk<span class=w> </span>init<span class=w> </span>app<span class=w> </span>--language<span class=w> </span>typescript
npm<span class=w> </span>i<span class=w> </span>typescript@~4.8.4
npm<span class=w> </span>i<span class=w> </span>@aws-quickstart/eks-blueprints
</code></pre></div> <ul> <li> <p>If not done before, bootstrap CDK (the following command is to bootstrap CDK in 3 regions)</p> <div class=highlight><pre><span></span><code>cdk<span class=w> </span>bootstrap<span class=w> </span>--trust<span class=o>=</span><span class=nv>$ACCOUNT_ID</span><span class=w> </span><span class=se>\</span>
<span class=w>  </span>--cloudformation-execution-policies<span class=w> </span>arn:aws:iam::aws:policy/AdministratorAccess<span class=w> </span><span class=se>\</span>
<span class=w>    </span>aws://<span class=nv>$ACCOUNT_ID</span>/<span class=nv>$AWS_REGION</span><span class=w> </span>aws://<span class=nv>$ACCOUNT_ID</span>/us-east-2<span class=w> </span>aws://<span class=nv>$ACCOUNT_ID</span>/us-east-1
</code></pre></div> </li> </ul> <p><a href=https://github.com/jbcodeforce/yarfba/tree/main/labs/cdk/eks-single>See the code in labs/cdk/eks-single</a></p> <ul> <li>Create a Cluster using the eks-blueprints package, which is published as a npm module.</li> </ul> <div class=highlight><pre><span></span><code><span class=k>import</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>cdk</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;aws-cdk-lib&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Construct</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;constructs&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>blueprints</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@aws-quickstart/eks-blueprints&#39;</span><span class=p>;</span>

<span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>ClusterConstruct</span><span class=w> </span><span class=k>extends</span><span class=w> </span><span class=nx>Construct</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=kr>constructor</span><span class=p>(</span><span class=nx>scope</span><span class=o>:</span><span class=w> </span><span class=nx>Construct</span><span class=p>,</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>,</span><span class=w> </span><span class=nx>props</span><span class=o>?:</span><span class=w> </span><span class=nx>cdk</span><span class=p>.</span><span class=nx>StackProps</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>super</span><span class=p>(</span><span class=nx>scope</span><span class=p>,</span><span class=w> </span><span class=nx>id</span><span class=p>);</span>

<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>props</span><span class=o>?</span><span class=p>.</span><span class=nx>env</span><span class=o>?</span><span class=p>.</span><span class=nx>account</span><span class=o>!</span><span class=p>;</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>region</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>props</span><span class=o>?</span><span class=p>.</span><span class=nx>env</span><span class=o>?</span><span class=p>.</span><span class=nx>region</span><span class=o>!</span><span class=p>;</span>

<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>blueprint</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>blueprints</span><span class=p>.</span><span class=nx>EksBlueprint</span><span class=p>.</span><span class=nx>builder</span><span class=p>()</span>
<span class=w>    </span><span class=p>.</span><span class=nx>account</span><span class=p>(</span><span class=nx>account</span><span class=p>)</span>
<span class=w>    </span><span class=p>.</span><span class=nx>region</span><span class=p>(</span><span class=nx>region</span><span class=p>)</span>
<span class=w>    </span><span class=p>.</span><span class=nx>addOns</span><span class=p>()</span>
<span class=w>    </span><span class=p>.</span><span class=nx>teams</span><span class=p>()</span>
<span class=w>    </span><span class=p>.</span><span class=nx>build</span><span class=p>(</span><span class=nx>scope</span><span class=p>,</span><span class=w> </span><span class=nx>id</span><span class=o>+</span><span class=s1>&#39;-stack&#39;</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>And in the app instantiate the cluster construct:</p> <div class=highlight><pre><span></span><code><span class=ch>#!/usr/bin/env node</span>
<span class=k>import</span><span class=w> </span><span class=s1>&#39;source-map-support/register&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>cdk</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;aws-cdk-lib&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=nx>ClusterConstruct</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../lib/my-eks-blueprints-stack&#39;</span><span class=p>;</span>

<span class=kd>const</span><span class=w> </span><span class=nx>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>cdk</span><span class=p>.</span><span class=nx>App</span><span class=p>();</span>
<span class=kd>const</span><span class=w> </span><span class=nx>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CDK_DEFAULT_ACCOUNT</span><span class=o>!</span><span class=p>;</span>
<span class=kd>const</span><span class=w> </span><span class=nx>region</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CDK_DEFAULT_REGION</span><span class=p>;</span>
<span class=kd>const</span><span class=w> </span><span class=nx>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>account</span><span class=p>,</span><span class=w> </span><span class=nx>region</span><span class=w> </span><span class=p>}</span>

<span class=ow>new</span><span class=w> </span><span class=nx>ClusterConstruct</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;cluster&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>env</span><span class=w> </span><span class=p>});</span>
</code></pre></div> <ul> <li>Deploy the cluster: <code>cdk deploy cluster-stack</code>, then config kubectl</li> </ul> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>KUBE_CONFIG</span><span class=o>=</span><span class=k>$(</span>aws<span class=w> </span>cloudformation<span class=w> </span>describe-stacks<span class=w> </span>--stack-name<span class=w> </span>cluster-stack<span class=w> </span><span class=p>|</span><span class=w> </span>jq<span class=w> </span>-r<span class=w> </span><span class=s1>&#39;.Stacks[0].Outputs[] | select(.OutputKey|match(&quot;ConfigCommand&quot;))| .OutputValue&#39;</span><span class=k>)</span>
<span class=nv>$KUBE_CONFIG</span>
kubectl<span class=w> </span>get<span class=w> </span>svc
</code></pre></div> <ul> <li><a href=https://github.com/aws-samples/cdk-eks-blueprints-patterns>EKS Blueprints Patterns</a></li> </ul> <h4 id=onboard-teams>Onboard teams<a class=headerlink href=#onboard-teams title="Permanent link">&para;</a></h4> <p>We want two teams: platform and application teams.</p> <div class=highlight><pre><span></span><code>mkdir<span class=w> </span>teams<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>cd</span><span class=w> </span>teams<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>mkdir<span class=w> </span>platform-team<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>mkdir<span class=w> </span>application-team
aws<span class=w> </span>iam<span class=w> </span>create-user<span class=w> </span>--user-name<span class=w> </span>platform
aws<span class=w> </span>iam<span class=w> </span>create-user<span class=w> </span>--user-name<span class=w> </span>application
</code></pre></div> <p>Under <code>platform-team</code> create a <code>init.ts</code>, Add a IAM Principal to add users to the platform using their IAM credentials</p> <div class=highlight><pre><span></span><code><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>ArnPrincipal</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;aws-cdk-lib/aws-iam&quot;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PlatformTeam</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@aws-quickstart/eks-blueprints&#39;</span><span class=p>;</span>

<span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>TeamPlatform</span><span class=w> </span><span class=k>extends</span><span class=w> </span><span class=nx>PlatformTeam</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kr>constructor</span><span class=p>(</span><span class=nx>accountID</span><span class=o>:</span><span class=w> </span><span class=nx>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=k>super</span><span class=p>({</span>
<span class=w>            </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;platform&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=nx>users</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=ow>new</span><span class=w> </span><span class=nx>ArnPrincipal</span><span class=p>(</span><span class=sb>`arn:aws:iam::</span><span class=si>${</span><span class=nx>accountID</span><span class=si>}</span><span class=sb>:user/platform`</span><span class=p>)]</span>
<span class=w>        </span><span class=p>})</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>And do the same for application team. Then modify the cluster definition to add team instances: The <code>cdk deploy cluster-stack</code> will create a new namespace for the team application.</p> <div class=highlight><pre><span></span><code><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>TeamPlatform</span><span class=p>,</span><span class=w> </span><span class=nx>TeamApplication</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../teams&#39;</span><span class=p>;</span><span class=w> </span>
<span class=p>...</span>
<span class=p>.</span><span class=nx>teams</span><span class=p>(</span><span class=ow>new</span><span class=w> </span><span class=nx>TeamPlatform</span><span class=p>(</span><span class=nx>account</span><span class=p>),</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>TeamApplication</span><span class=p>(</span><span class=s1>&#39;burnham&#39;</span><span class=p>,</span><span class=nx>account</span><span class=p>))</span>
</code></pre></div> <p>A command like <code>kubectl describe role -n team-burnham</code> gives information on the role and actions that member can do.</p> <p>Using Kubernetes constructs such as namespaces, quotas, and network policies, we can prevent applications deployed in different namespaces from communicating with each other.</p> <ul> <li> <p>To see the application user access limitation, login to the console in incognito mode, use the account ID, application as user and be sure to have setup a password in IAM for the <code>application</code> user. Once logged assume the role of cluster-stack-teamburnhamAccessRole3.... Then go to the EKS console. We should see an error message that the Team Burnham user is NOT allowed to list deployments in all the namespaces. But selecting the <code>team-burnham</code> namespace we should see pods and other elements.</p> </li> <li> <p>The user platform with the role <code>cluster-stack-templatformAccessRole5...</code> can access the cluster as admin and see all namespaces.</p> </li> </ul> <h4 id=adding-add-ons>Adding add-ons<a class=headerlink href=#adding-add-ons title="Permanent link">&para;</a></h4> <p><a href=https://aws-quickstart.github.io/cdk-eks-blueprints/addons/ >See the list of supported add-ons</a>. To add them use the addOn() function in the blueprint:</p> <div class=highlight><pre><span></span><code>  const blueprint = blueprints.EksBlueprint.builder()
    .account(account)
    .region(region)
    .addOns(new blueprints.ClusterAutoScalerAddOn)
    .teams(new TeamPlatform(account), new TeamApplication(&#39;burnham&#39;,account))
    .build(scope, id+&#39;-stack&#39;);
  }
</code></pre></div> <h2 id=autoscaling-the-cluster>Autoscaling the cluster<a class=headerlink href=#autoscaling-the-cluster title="Permanent link">&para;</a></h2> <ul> <li> <p><strong>Horizontal Pod Autoscaler (HPA)</strong> scales the pods in a deployment or replica set. It is implemented as a K8s API resource and a controller. The controller manager queries the resource utilization against the metrics specified in each HorizontalPodAutoscaler definition. It obtains the metrics from either the resource metrics API (for per-pod resource metrics), or the custom metrics API (for all other metrics).</p> <div class=highlight><pre><span></span><code><span class=c1># Example of setting HPA on a pod/deployment</span>
kubectl<span class=w> </span>autoscale<span class=w> </span>deployment<span class=w> </span>php-apache<span class=w> </span><span class=sb>`</span><span class=c1>#The target average CPU utilization` \</span>
--cpu-percent<span class=o>=</span><span class=m>50</span><span class=w> </span><span class=se>\</span>
--min<span class=o>=</span><span class=m>1</span><span class=w> </span><span class=sb>`</span><span class=c1>#The lower limit for the number of pods that can be set by the autoscaler` \</span>
--max<span class=o>=</span><span class=m>10</span><span class=w> </span>
kubectl<span class=w> </span>get<span class=w> </span>hpa
</code></pre></div> </li> <li> <p><strong>Cluster Autoscaler (CAS)</strong> is a <a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider/aws>component</a> that automatically adjusts the size of a Kubernetes Cluster so that all pods have a place to run and there are no unneeded nodes. Cluster Autoscaler typically runs as a Deployment in our cluster. It delegates to the Auto Scaling Group for EC2s to manage node groups. So be sure to configure the ASG with min, max and desired EC2 instance counts. With Fargate we do not need the cluster autoscaler. When creating a managed node group, we can choose either the On-Demand or Spot capacity type. The allocation strategy to provision Spot capacity is set to capacity-optimized to ensure that the Spot nodes are provisioned in the optimal Spot capacity pools.</p> </li> <li> <p><a href=https://karpenter.sh/ >Karpenter</a> observes the aggregate resource requests of unscheduled pods and makes decisions to launch and terminate nodes to minimize scheduling latencies and infrastructure cost. It is installed to the EKS cluster using Helm, and configured with CRD. Karpenter scales up nodes in a group-less approach. Karpenter selects which nodes to scale , based on the number of pending pods and the Provisioner configuration. It selects how the best instances for the workload should look like, and then provisions those instances. Karpenter uses cordon and drain best practices to terminate nodes. The configuration of when a node is terminated can be controlled with <code>ttlSecondsAfterEmpty</code>.</p> </li> </ul> <p>See <a href=https://aws.amazon.com/premiumsupport/knowledge-center/eks-install-karpenter/ >support note: How do I install Karpenter in my Amazon EKS cluster</a>.</p> <h2 id=deeper-dive>Deeper Dive<a class=headerlink href=#deeper-dive title="Permanent link">&para;</a></h2> <ul> <li><a href=https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html>Product documentation - Elastic Kubernetes Service</a></li> <li><a href=https://www.eksworkshop.com/ >EKS workshops</a>.</li> <li><a href=https://catalog.us-east-1.prod.workshops.aws/workshops/a1101fcc-c7cf-4dd5-98c4-f599a65056d5/en-US>Web Application Hosts on EKS Workshop</a> uses terraform to create the VPC, and EKS cluster + deploy a web app as an example.</li> <li><a href=https://catalog.workshops.aws/eks-blueprints-for-cdk/en-US>EKS Blueprints for CDK Workshop</a>.</li> <li><a href=https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html>Getting started with Amazon EKS – eksctl</a>.</li> <li><a href=https://aws.github.io/aws-eks-best-practices/ >EKS Best Practices Guides in github</a>.</li> <li><a href=https://aws.amazon.com/blogs/containers/bootstrapping-clusters-with-eks-blueprints/ >EKS Blueprint bootstrap</a>.</li> <li><a href=https://aws-ia.github.io/terraform-aws-eks-blueprints/getting-started/ >Amazon EKS Blueprints for Terraform</a>.</li> <li><a href=https://catalog.us-east-1.prod.workshops.aws/workshops/e04c0885-830a-479b-844b-4c7af79697f8/en-US>EKS SaaS workshop</a>.</li> <li><a href=https://kops.sigs.k8s.io/getting_started/aws/ >kOps open source project for running k8s cluster on any cloud provider.</a></li> <li><a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-is-cluster-autoscaler>Cluster Autoscaler CAS FAQs</a>.</li> <li><a href=https://aws.amazon.com/blogs/containers/amazon-eks-control-plane-auto-scaling-enhancements-improve-speed-by-4x/ >EKS improves control plane scaling and update speed by up to 4x.</a></li> <li><a href=https://aws.amazon.com/blogs/containers/eliminate-kubernetes-node-scaling-lag-with-pod-priority-and-over-provisioning/ >Eliminate Kubernetes node scaling lag with pod priority and over-provisioning</a>.</li> <li><a href=https://aws.amazon.com/blogs/containers/how-h2o-ai-optimized-and-secured-their-ai-ml-infrastructure-with-karpenter-and-bottlerocket/ >How H2O.ai optimized and secured their AI/ML infrastructure with Karpenter and Bottlerocket.</a></li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../ecs/ class="md-footer__link md-footer__link--prev" aria-label="Previous: ECS"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> ECS </div> </div> </a> <a href=../msk/ class="md-footer__link md-footer__link--next" aria-label="Next: MSK"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> MSK </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "navigation.instant", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.af256bd8.min.js></script> </body> </html>