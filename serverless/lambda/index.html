<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jerome Boyer"><link href=../ rel=prev><link href=../apigtw/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.33"><title>Lambda - AWS Studies</title><link rel=stylesheet href=../../assets/stylesheets/main.3cba04c6.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#aws-lambda class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="AWS Studies" class="md-header__button md-logo" aria-label="AWS Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> AWS Studies </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Lambda </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/yarfba.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="AWS Studies" class="md-nav__button md-logo" aria-label="AWS Studies" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> AWS Studies </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/yarfba.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Infrastructure </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../infra/ class=md-nav__link> <span class=md-ellipsis> EC2-others </span> </a> </li> <li class=md-nav__item> <a href=../../infra/networking/ class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> <li class=md-nav__item> <a href=../../infra/security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> <li class=md-nav__item> <a href=../../infra/storage/ class=md-nav__link> <span class=md-ellipsis> S3-Storage </span> </a> </li> <li class=md-nav__item> <a href=../../infra/route53/ class=md-nav__link> <span class=md-ellipsis> Route 53 </span> </a> </li> <li class=md-nav__item> <a href=../../monitoring/monitoring/ class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../../monitoring/cost/ class=md-nav__link> <span class=md-ellipsis> Cost mgt </span> </a> </li> <li class=md-nav__item> <a href=../../kinesis/ class=md-nav__link> <span class=md-ellipsis> Kinesis* </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../sa/well-architectured/ class=md-nav__link> <span class=md-ellipsis> Well Architectured </span> </a> </li> <li class=md-nav__item> <a href=../../sa/sol-design/ class=md-nav__link> <span class=md-ellipsis> Solution design </span> </a> </li> <li class=md-nav__item> <a href=../../sa/psa-role/ class=md-nav__link> <span class=md-ellipsis> SA </span> </a> </li> <li class=md-nav__item> <a href=../../sa/saas/ class=md-nav__link> <span class=md-ellipsis> SaaS </span> </a> </li> <li class=md-nav__item> <a href=../../sa/resiliency/ class=md-nav__link> <span class=md-ellipsis> Resiliency </span> </a> </li> <li class=md-nav__item> <a href=../../templ/ class=md-nav__link> <span class=md-ellipsis> Conduct Design session </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Analytics </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Analytics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../analytics/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../analytics/emr/ class=md-nav__link> <span class=md-ellipsis> EMR </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../data/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../data/rds/ class=md-nav__link> <span class=md-ellipsis> RDS-Aurora </span> </a> </li> <li class=md-nav__item> <a href=../../data/dynamodb/ class=md-nav__link> <span class=md-ellipsis> DynamoDB </span> </a> </li> <li class=md-nav__item> <a href=../../data/data-lake/ class=md-nav__link> <span class=md-ellipsis> Data Lake </span> </a> </li> <li class=md-nav__item> <a href=../../data/redshift/ class=md-nav__link> <span class=md-ellipsis> RedShift </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> AI-ML </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> AI-ML </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ai-ml/ class=md-nav__link> <span class=md-ellipsis> All Services </span> </a> </li> <li class=md-nav__item> <a href=../../ai-ml/sagemaker/ class=md-nav__link> <span class=md-ellipsis> SageMaker </span> </a> </li> <li class=md-nav__item> <a href=../../ai-ml/bedrock/ class=md-nav__link> <span class=md-ellipsis> Bedrock </span> </a> </li> <li class=md-nav__item> <a href=../../ai-ml/q/ class=md-nav__link> <span class=md-ellipsis> Amazon Q </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Serverless </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Serverless </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Lambda </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Lambda </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#lambda-execution-environment class=md-nav__link> <span class=md-ellipsis> Lambda Execution environment </span> </a> </li> <li class=md-nav__item> <a href=#scaling class=md-nav__link> <span class=md-ellipsis> Scaling </span> </a> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#criteria-to-use-lambda class=md-nav__link> <span class=md-ellipsis> Criteria to use lambda </span> </a> <nav class=md-nav aria-label="Criteria to use lambda"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#technical-constraints class=md-nav__link> <span class=md-ellipsis> Technical constraints </span> </a> </li> <li class=md-nav__item> <a href=#design-constraints class=md-nav__link> <span class=md-ellipsis> Design constraints </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security class=md-nav__link> <span class=md-ellipsis> Security </span> </a> <nav class=md-nav aria-label=Security> <ul class=md-nav__list> <li class=md-nav__item> <a href=#policies-and-roles class=md-nav__link> <span class=md-ellipsis> Policies and roles </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#monitoring class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> <nav class=md-nav aria-label=Monitoring> <ul class=md-nav__list> <li class=md-nav__item> <a href=#custom-metrics class=md-nav__link> <span class=md-ellipsis> Custom metrics </span> </a> </li> <li class=md-nav__item> <a href=#using-the-embedded-metric-format class=md-nav__link> <span class=md-ellipsis> Using the Embedded Metric Format </span> </a> </li> <li class=md-nav__item> <a href=#find-cold-starts class=md-nav__link> <span class=md-ellipsis> Find cold starts </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#hands-on class=md-nav__link> <span class=md-ellipsis> Hands-on </span> </a> <nav class=md-nav aria-label=Hands-on> <ul class=md-nav__list> <li class=md-nav__item> <a href=#getting-started class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=#python-function-with-dependencies class=md-nav__link> <span class=md-ellipsis> Python function with dependencies </span> </a> </li> <li class=md-nav__item> <a href=#java-based-function class=md-nav__link> <span class=md-ellipsis> Java based function </span> </a> </li> <li class=md-nav__item> <a href=#cicd class=md-nav__link> <span class=md-ellipsis> CI/CD </span> </a> </li> <li class=md-nav__item> <a href=#other-personal-implementations class=md-nav__link> <span class=md-ellipsis> Other personal implementations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#faqs class=md-nav__link> <span class=md-ellipsis> FAQs </span> </a> </li> <li class=md-nav__item> <a href=#best-practices class=md-nav__link> <span class=md-ellipsis> Best practices </span> </a> </li> <li class=md-nav__item> <a href=#more-reading class=md-nav__link> <span class=md-ellipsis> More reading </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../apigtw/ class=md-nav__link> <span class=md-ellipsis> API Gateway </span> </a> </li> <li class=md-nav__item> <a href=../ecs/ class=md-nav__link> <span class=md-ellipsis> ECS </span> </a> </li> <li class=md-nav__item> <a href=../eks/ class=md-nav__link> <span class=md-ellipsis> EKS </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study class=md-nav__link> <span class=md-ellipsis> Messaging </span> </a> </li> <li class=md-nav__item> <a href=../msk/ class=md-nav__link> <span class=md-ellipsis> MSK </span> </a> </li> <li class=md-nav__item> <a href=../../kinesis/ class=md-nav__link> <span class=md-ellipsis> Kinesis* </span> </a> </li> <li class=md-nav__item> <a href=../eventbridge/ class=md-nav__link> <span class=md-ellipsis> EventBridge </span> </a> </li> <li class=md-nav__item> <a href=../stepfct/ class=md-nav__link> <span class=md-ellipsis> Step function </span> </a> </li> <li class=md-nav__item> <a href=../mwaa/ class=md-nav__link> <span class=md-ellipsis> MWAA </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Playground </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Playground </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../playground/ class=md-nav__link> <span class=md-ellipsis> AWS personal labs </span> </a> </li> <li class=md-nav__item> <a href=../../playground/gettingstarted/ class=md-nav__link> <span class=md-ellipsis> Getting Started EC2 </span> </a> </li> <li class=md-nav__item> <a href=../../playground/security/ class=md-nav__link> <span class=md-ellipsis> Security-IAM demos </span> </a> </li> <li class=md-nav__item> <a href=../../playground/s3-play/ class=md-nav__link> <span class=md-ellipsis> S3 play </span> </a> </li> <li class=md-nav__item> <a href=../../playground/networking/ class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> <li class=md-nav__item> <a href=../../playground/rds/ class=md-nav__link> <span class=md-ellipsis> RDS </span> </a> </li> <li class=md-nav__item> <a href=../../playground/rt-data-processing/ class=md-nav__link> <span class=md-ellipsis> Data processing </span> </a> </li> <li class=md-nav__item> <a href=../../playground/spark-emr/ class=md-nav__link> <span class=md-ellipsis> Analytics on EMR </span> </a> </li> <li class=md-nav__item> <a href=../../playground/ecs/ class=md-nav__link> <span class=md-ellipsis> ECS </span> </a> </li> <li class=md-nav__item> <a href=../../playground/s3-org-billing/ class=md-nav__link> <span class=md-ellipsis> S3 storage lens </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/big-data-tenant-analytics/ class=md-nav__link> <span class=md-ellipsis> SaaS demo </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> Coding </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../coding/ class=md-nav__link> <span class=md-ellipsis> Practices </span> </a> </li> <li class=md-nav__item> <a href=../../coding/sam/ class=md-nav__link> <span class=md-ellipsis> SAM </span> </a> </li> <li class=md-nav__item> <a href=../../coding/cloudFormation/ class=md-nav__link> <span class=md-ellipsis> CloudFormation </span> </a> </li> <li class=md-nav__item> <a href=../../coding/cdk/ class=md-nav__link> <span class=md-ellipsis> CDK </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io class=md-nav__link> <span class=md-ellipsis> Return to main </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#lambda-execution-environment class=md-nav__link> <span class=md-ellipsis> Lambda Execution environment </span> </a> </li> <li class=md-nav__item> <a href=#scaling class=md-nav__link> <span class=md-ellipsis> Scaling </span> </a> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#criteria-to-use-lambda class=md-nav__link> <span class=md-ellipsis> Criteria to use lambda </span> </a> <nav class=md-nav aria-label="Criteria to use lambda"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#technical-constraints class=md-nav__link> <span class=md-ellipsis> Technical constraints </span> </a> </li> <li class=md-nav__item> <a href=#design-constraints class=md-nav__link> <span class=md-ellipsis> Design constraints </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security class=md-nav__link> <span class=md-ellipsis> Security </span> </a> <nav class=md-nav aria-label=Security> <ul class=md-nav__list> <li class=md-nav__item> <a href=#policies-and-roles class=md-nav__link> <span class=md-ellipsis> Policies and roles </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#monitoring class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> <nav class=md-nav aria-label=Monitoring> <ul class=md-nav__list> <li class=md-nav__item> <a href=#custom-metrics class=md-nav__link> <span class=md-ellipsis> Custom metrics </span> </a> </li> <li class=md-nav__item> <a href=#using-the-embedded-metric-format class=md-nav__link> <span class=md-ellipsis> Using the Embedded Metric Format </span> </a> </li> <li class=md-nav__item> <a href=#find-cold-starts class=md-nav__link> <span class=md-ellipsis> Find cold starts </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#hands-on class=md-nav__link> <span class=md-ellipsis> Hands-on </span> </a> <nav class=md-nav aria-label=Hands-on> <ul class=md-nav__list> <li class=md-nav__item> <a href=#getting-started class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=#python-function-with-dependencies class=md-nav__link> <span class=md-ellipsis> Python function with dependencies </span> </a> </li> <li class=md-nav__item> <a href=#java-based-function class=md-nav__link> <span class=md-ellipsis> Java based function </span> </a> </li> <li class=md-nav__item> <a href=#cicd class=md-nav__link> <span class=md-ellipsis> CI/CD </span> </a> </li> <li class=md-nav__item> <a href=#other-personal-implementations class=md-nav__link> <span class=md-ellipsis> Other personal implementations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#faqs class=md-nav__link> <span class=md-ellipsis> FAQs </span> </a> </li> <li class=md-nav__item> <a href=#best-practices class=md-nav__link> <span class=md-ellipsis> Best practices </span> </a> </li> <li class=md-nav__item> <a href=#more-reading class=md-nav__link> <span class=md-ellipsis> More reading </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=aws-lambda><a href=https://docs.aws.amazon.com/lambda/latest/dg/welcome.html>AWS Lambda</a><a class=headerlink href=#aws-lambda title="Permanent link">&para;</a></h1> <p>This document is a quick summary of the AWS Lambda technology, links to interesting content, labs, and sharing some best practices.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Created 11/2023 - Updated 01/29/2024</p> </div> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>With AWS Lambda, we can run code without provisioning or managing servers or containers.</p> <p>Upload the source code, and Lambda takes care of everything required to run and scale the code with high availability.</p> <ul> <li><a href=https://aws.amazon.com/getting-started/hands-on/run-serverless-code/ >Getting started tutorial with free tier</a></li> <li> <p>Pay only for what we use: # of requests and CPU time, and the amount of memory allocated.</p> </li> <li> <p>A Lambda function has three primary components – trigger, code, and configuration.</p> <p><img alt src=../images/lambda-fct-0.png width=800></p> <ul> <li><strong>Triggers</strong> describe when a Lambda function should run. A trigger integrates the Lambda function with other AWS services, enabling to run the Lambda function in response to certain API calls that occur in the AWS account.</li> <li>An <strong>execution environment</strong> manages the processes and resources that are required to run the function. </li> <li><strong>Configuration</strong> includes compute resources, execution timeout, IAM roles (lambda_basic_execution)...</li> </ul> </li> </ul> <h3 id=lambda-execution-environment>Lambda Execution environment<a class=headerlink href=#lambda-execution-environment title="Permanent link">&para;</a></h3> <ul> <li> <p>The execution environment follows the <a href=https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtime-environment.html>life cycle</a> as defined below (time goes from left to right):</p> <p><img alt src=../images/lamba-env-lc.png width=800></p> <ul> <li>In the <strong>Init phase</strong> Lambda creates or unfreezes an execution environment with the configured resources, downloads the code for the function and all the needed layers, initializes any extensions, initializes the runtime, and then runs the function’s initialization code. After init, the environment is 'Warm'. The extension and runtime inits is part of the <code>cold start</code> (&lt;1s). </li> <li>In the <strong>Invoke phase</strong> Lambda invokes the function handler. After the function runs to completion, Lambda prepares to handle another function invocation.</li> <li>During <strong>Shutdown phase:</strong> Lambda shuts down the runtime, alerts the extensions to let them stop cleanly, and then removes the environment.</li> </ul> </li> </ul> <details class="- info"> <summary>Lambda Extension</summary> <p>Lambda supports external and internal <a href=https://docs.aws.amazon.com/lambda/latest/dg/lambda-extensions.html>extensions</a>. An external extension runs as an independent process in the execution environment and continues to run after the function invocation is fully processed. Can be used for logging, monitoring, integration...</p> </details> <ul> <li>The Lambda service is split into the control plane and the data plane. The control plane provides the management APIs (for example, <code>CreateFunction</code>, <code>UpdateFunctionCode</code>). The data plane is where Lambda's API resides to invoke the Lambda functions. It is HA over multi AZs in same region.</li> <li> <p>Lambda Workers are bare metal Amazon EC2 Nitro instances which are launched and managed by Lambda in a separate isolated AWS account which is not visible to customers. Each workers has one to many <a href=https://aws.amazon.com/blogs/aws/firecracker-lightweight-virtualization-for-serverless-computing/ >Firecraker microVMs</a>. There is no container engine. Container image is just for packaging the lambda code as zip does.</p> <p><img alt src=../diagrams/lambda-arch.drawio.png width=1000></p> <ul> <li>Synchronous calls is used for immediate function response, with potential errors returned to the caller. It may return throttles when we hit the concurrency limit.</li> <li>Asynchronous calls return an acknowledgement message. Event payloads are always queued for processing before invocation. Internal SQS queue persists messages for up to 6 hours. Queued events are retrieved in batches by Lambda’s poller fleet. The poller fleet is a group of Amazon EC2 instances whose purpose is to process queued event invocations which have not yet been processed. When an event fails all processing attempts, it is discarded by Lambda. The dead letter queue (DLQ) feature allows sending unprocessed events from asynchronous invocations to an Amazon SQS queue or an Amazon SNS topic defined by the customer. Asynchronous processing should be more scalable.</li> <li>Event source mapping is used to pull messages from different streaming sources and then synchronously calls the Lambda function. It reads using batching and send all the events as argument to the function. If the function returns an error for any of the messages in a batch, Lambda retries the whole batch of messages until processing succeeds or the messages expire. It supports error handling. </li> <li>If the service is not available. Callers may queue the payload on client-side to retry. If the invoke service receives the payload, the service attempts to identify an available execution environment for the request and passes the payload to that execution environment to complete the invocation. It may lead to create this execution environment.</li> </ul> <p><img alt src=../images/req-rep-lambda.png width=800></p> </li> <li> <p>There is at least one runtime which matches the programming language (Java, Node.js, C#, Go, or Python).</p> </li> <li>To reuse code in more than one function, consider creating a Layer and deploying it. A layer is a ZIP archive that contains libraries, a custom runtime, or other dependencies.</li> <li> <p>Lambda supports versioning and developer can maintain one or more versions of the lambda function. We can reduce the risk of deploying a new version by configuring the alias to send most of the traffic to the existing version, and only a small percentage of traffic to the new version. Below is an example of creating one Alias to version 1 and a routing config with Weight at 30% to version 2. Alias enables promoting new lambda function version to production and if we need to rollback a function, we can simply update the alias to point to the desired version. Event source needs to use Alias ARN for invoking the lambda function.</p> <div class=highlight><pre><span></span><code>aws<span class=w> </span>lambda<span class=w> </span>create-alias<span class=w> </span>--name<span class=w> </span>routing-alias<span class=w> </span>--function-name<span class=w> </span>my-function<span class=w> </span>--function-version<span class=w> </span><span class=m>1</span><span class=w>  </span>--routing-config<span class=w> </span><span class=nv>AdditionalVersionWeights</span><span class=o>={</span><span class=s2>&quot;2&quot;</span><span class=o>=</span><span class=m>0</span>.03<span class=o>}</span>
</code></pre></div> </li> <li> <p>Each lambda function has a unique ARN.</p> </li> <li>Deployment package is a zip or container image.</li> </ul> <h3 id=scaling>Scaling<a class=headerlink href=#scaling title="Permanent link">&para;</a></h3> <p>Lambda invokes the code in a secure and isolated execution environment, which needs to be initialized and then executes the function code for the unique request it handles. Second request will not have the initialization step. When requests arrive, Lambda reuses available execution environments, and creates new ones if necessary.</p> <p>The number of execution environments determines the concurrency. Limited to 1000 by default.</p> <p>Concurrency (# of in-flight requests the function is currently handling) is subject to quotas at the AWS Account/Region level. <a href=https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html>See quotas documentation.</a></p> <p>When the number of requests decreases, Lambda stops unused execution environments to free up scaling capacity for other functions.</p> <p>Use the Lambda CloudWatch metric named <code>ConcurrentExecutions</code> to view concurrent invocations for all or individual functions. To estimate concurrent requests use: <strong>Request per second * Avg duration in seconds = concurrent requests</strong></p> <p>Lambda scales to very high limits, but not all account's concurrency quota is available immediately, so requests could be throttled for a few minutes in case of burst. </p> <p>There are two scaling quotas to consider with concurrency. Account concurrency quota (1000 per region) and burst concurrency quota (from 500 to 3000 per min per region). Further requests are throttled, and lambda returns HTTP 429 (too many requests).</p> <p>It is possible to use <a href=https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html><strong>Reserved concurrency</strong></a>, which splits the pool of available concurrency into subsets. A function with reserved concurrency only uses concurrency from its dedicated pool. This is helpful to avoid one lambda function to take all the concurrency quota and impact other functions in the same region. No extra charges.</p> <p>For functions that take a long time to initialize, or that require extremely low latency for all invocations, <strong>provisioned concurrency</strong> enables to pre-initialize instances of the function and keep them running at all times.</p> <p>Use <code>concurrency limit</code> to guarantee concurrency availability for a function, or to avoid overwhelming a downstream resource that the function is interacting with.</p> <p>If the test results uncover situations where functions from different applications or different environments are competing with each other for concurrency, developers probably need to rethink the account segregation strategy and consider moving to a multi-account strategy.</p> <p>Memory is the only setting that can impact performance. Both CPU and I/O scale linearly with memory configuration. We can allocate up to 10 GB of memory to a Lambda function. In case of low performance, start by adding memory to the lambda.</p> <p><img alt src=../images/lambda-mem-cfg.png></p> <ul> <li><a href=https://github.com/alexcasalboni/aws-lambda-power-tuning>AWS Lambda Power Tuning tool to find the right memory configuration</a>.</li> <li><a href=https://aws.amazon.com/blogs/compute/understanding-aws-lambda-scaling-and-throughput/ >Understanding AWS Lambda scaling and throughput - an AWS blog</a>.</li> </ul> <h3 id=networking>Networking<a class=headerlink href=#networking title="Permanent link">&para;</a></h3> <ul> <li>Lambda functions always operate from an AWS-owned VPC. By default, the function has the full ability to make network requests to any public internet addresses — this includes access to any of the public AWS APIs.</li> <li>Only enable the functions to run inside the context of a private subnet in a VPC, when we need to interact with a private resource located in a private subnet. In this case we need to enable internet outbound connection, like NAT, network policies, IGW.</li> <li>When connecting a Lambda function to a VPC, Lambda creates an elastic network interface, ENI, for each combination of subnet and security group attached to the function.</li> </ul> <h4 id=private-resource-within-vpc>Private resource within VPC<a class=headerlink href=#private-resource-within-vpc title="Permanent link">&para;</a></h4> <p>![]</p> <h4 id=api-gateway-integration>API Gateway integration<a class=headerlink href=#api-gateway-integration title="Permanent link">&para;</a></h4> <p>Resources defined as API in Amazon API Gateway may define one or more methods, such as GET or POST which integration routes requests to a Lambda function. We can add a Trigger to a Lambda to get a HTTP API integration from the API Gateway. We configure API Gateway to pass the body of the HTTP request as-is.</p> <p>The event format is defined <a href=https://docs.aws.amazon.com/lambda/latest/dg/services-apigateway.html#apigateway-example-event>here</a>.</p> <h4 id=edge-function>Edge Function<a class=headerlink href=#edge-function title="Permanent link">&para;</a></h4> <p>When we need to customize the CDN content, we can use Edge Function to run closer to the end users.</p> <p>CloudFront provides two types: CloudFront functions or Lambda@Edge.</p> <p>Edge can be used for:</p> <ul> <li>Website security and privacy.</li> <li>Dynamic web application at the Edge.</li> <li>Search engine optimization (SEO).</li> <li>Intelligently route across origins and data centers.</li> <li>Bot mitigation at the Edge.</li> <li>Real-time image transformation.</li> <li>User authentication and authorization.</li> </ul> <h2 id=criteria-to-use-lambda>Criteria to use lambda<a class=headerlink href=#criteria-to-use-lambda title="Permanent link">&para;</a></h2> <h3 id=technical-constraints>Technical constraints<a class=headerlink href=#technical-constraints title="Permanent link">&para;</a></h3> <ul> <li>Per region deployment.</li> <li>Must run under 15 min.</li> <li>Memory from 128MB to 10GB.</li> <li>Maximum 1000 concurrent calls.</li> <li>Code in compressed zip should be under 50MB and 250MB uncompressed.</li> <li>Disk capacity for /tmp is limited to 10GB.</li> </ul> <h3 id=design-constraints>Design constraints<a class=headerlink href=#design-constraints title="Permanent link">&para;</a></h3> <ul> <li>When migrating existing application <a href=../#designing-for-serverless>review the different design patterns to consider</a>.</li> <li>Think about co-existence with existing application and how API Gateway can be integrated to direct traffic to new components (Lambda functions) without disrupting existing systems. With <a href=../apigtw/ >API Gateway</a> developer can export the SDK for the business APIs to make integration easier for other clients, and can use throttling and usage plans to control how different clients can use the API.</li> <li>Do cost comparison analysis. For example API Gateway is pay by the requests, while ALB is priced by hours based on the load balance capacity units used per hour. Lambda is also per request based.</li> <li>Not everything fits into the function design. Assess if it makes sense to map REST operations in the same handler. AWS <a href=https://docs.powertools.aws.dev/lambda/python/latest/ >Lambda Powertools</a> has a APIGatewayRestResolver that makes the code neat with api being defined with annotation: see <a href=https://github.com/jbcodeforce/yarfba/tree/main/labs/lambdas/lambda-dynamo>Lambda DynamoDB example</a></li> <li>Assess when to use Fargate when the application is in container, and may run for a long time period. Larger packaging may not be possible to run on Lambda. Applications that use non HTTP end point, integrate to messaging middleware with Java based APIs are better fit for Fargate deployment.</li> </ul> <h2 id=security>Security<a class=headerlink href=#security title="Permanent link">&para;</a></h2> <p>As a managed service, AWS manages the underlying infrastructure and foundation services, the operating system, and the application platform. Developers need to ensure code, libraries, configuration, IAM are well set. Some security considerations:</p> <ul> <li>Data privacy with encryption at rest with customer managed Key, encryption in transit, access control.</li> <li>Function runtime environment variables are secured by encryption using a Lambda-managed KMS key (named <code>aws/lambda</code>). The <code>CreateFunction</code> API or <code>UpdateFunctionConfiguration</code> may use KMS Keys.</li> <li>AWS X-Ray also encrypts data by default.</li> <li>TLS1.2 for all public APIs.</li> <li>Run on EC2 with Nitro System for better security isolation.</li> <li> <p>Code releases go through security review and penetration testing. It provides a code signing feature to ensure only trusted code is run in the Lambda function.</p> </li> <li> <p>Lambda also supports function URLs, a built-in HTTPS endpoint for invoking functions. No need for API Gateway and ALB.</p> </li> <li>Each Lambda exec environment includes a writeable /tmp folder: files written within it, remain for the lifetime of the execution environment.</li> <li> <p>Also to enable the Lambda function to access resources inside the private VPC, we must provide additional VPC-specific configuration information that includes VPC subnet IDs and security group IDs and the <code>AWSLambdaVPCAccessExecutionRole</code> policy. AWS Lambda uses this information to set up elastic network interfaces (ENIs) that enable the function to connect securely to other resources in the VPC. </p> <p><img alt src=../diagrams/vpc-lambda.drawio.png></p> <p>As Lambda function always runs inside a VPC owned by the Lambda service, the function accesses resources in our VPC using a Hyperplane ENI. Hyperplane ENIs provide NAT capabilities from the Lambda VPC to our account VPC using VPC-to-VPC NAT (V2N).</p> <p>If it runs out of IP@ then we will have EC2 error types like <code>EC2ThrottledException</code> and the function will not scale. So be sure to have multiple AZ/ subnets and enough IP@.</p> </li> <li> <p>For the function to access the internet, route outbound traffic to a NAT gateway in one public subnet in the VPC.</p> </li> <li> <p>To establish a private connection between the VPC and Lambda, create an interface VPC endpoint (using AWS PrivateLink). Traffic between the VPC and Lambda does not leave the AWS network.</p> <div class=highlight><pre><span></span><code>aws<span class=w> </span>ec2<span class=w> </span>create-vpc-endpoint<span class=w> </span>--vpc-id<span class=w> </span>vpc-ec43eb89<span class=w> </span>--vpc-endpoint-type<span class=w> </span>Interface<span class=w> </span>--service-name<span class=w> </span><span class=se>\</span>
com.amazonaws.us-west-2.lambda<span class=w> </span>--subnet-id<span class=w> </span>subnet-abababab<span class=w> </span>--security-group-id<span class=w> </span>sg-1a2b3c4d<span class=w>      </span>
</code></pre></div> </li> </ul> <p>Endpoint policy can be attached to the interface endpoint to add more control on which resource inside the VPC can access the lambda function (Principal = user, Allow lambda:InvokeFunction on resource with the function arn).</p> <h3 id=policies-and-roles>Policies and roles<a class=headerlink href=#policies-and-roles title="Permanent link">&para;</a></h3> <p>With Lambda functions, there are two sides that define the necessary scope of permissions – permission to invoke the function (using <strong>resource policies</strong>), and permission of the Lambda function itself to act upon other services (IAM <strong>execution role</strong>).</p> <p>The <strong>execution role</strong> must include a trust policy that allows Lambda to “AssumeRole” so that it can take that action for another service.</p> <p>Lambda resource policies are :</p> <ul> <li>Associated with a "push" event source such as Amazon API Gateway.</li> <li>Created when we add a trigger to a Lambda function.</li> <li>Allows the event source to take the <code>lambda:InvokeFunction</code> action.</li> </ul> <p>We can use Parameter Store, from System Manager, to reference Secrets Manager secrets, creating a consistent and secure process for calling and using secrets and reference data in the code and configuration script. </p> <h2 id=monitoring>Monitoring<a class=headerlink href=#monitoring title="Permanent link">&para;</a></h2> <p>AWS Lambda automatically monitors Lambda functions and reports metrics through Amazon CloudWatch. To help monitoring the code as it executes, Lambda automatically tracks the number of requests, the latency per request, and the number of requests resulting in an error and publishes the associated metrics. Developer can leverage these metrics to set custom CloudWatch alarms.</p> <p>Distributed tracing helps pinpoint where failures occur and what causes poor performance. Tracing is about understanding the path of data as it propagates through the components of the application.</p> <p>Amazon CloudWatch Lambda Insights is a monitoring and troubleshooting solution for serverless applications running on Lambda. Lambda Insights collects, aggregates, and summarizes system-level metrics. It also summarizes diagnostic information such as cold starts and Lambda worker shutdowns to help isolate issues with the Lambda functions and resolve them quickly.</p> <p><strong>X-Ray</strong> provides an end-to-end view of requests as they travel through the application and the underlying components. Developer can use AWS X-Ray to visualize the components of the application, identify performance bottlenecks, and troubleshoot requests that resulted in an error.</p> <p>See this article: <a href=https://aws.amazon.com/blogs/compute/operating-lambda-logging-and-custom-metrics/ >Operating Lambda with logging and custom metrics.</a></p> <h3 id=custom-metrics>Custom metrics<a class=headerlink href=#custom-metrics title="Permanent link">&para;</a></h3> <p>Custom metrics can be used for tracking statistics in the application domain, instead of measuring performance related to the Lambda function. Use AWS SDK with the CloudWatch library and the <code>putMetricData</code> API.</p> <details class=-> <summary>Javascript Code Example</summary> <div class=highlight><pre><span></span><code><span class=kd>const</span><span class=w> </span><span class=nx>AWSXRay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;aws-xray-sdk-core&#39;</span><span class=p>)</span>
<span class=kd>const</span><span class=w> </span><span class=nx>AWS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>AWSXRay</span><span class=p>.</span><span class=nx>captureAWS</span><span class=p>(</span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;aws-sdk&#39;</span><span class=p>))</span>
<span class=kd>const</span><span class=w> </span><span class=nx>cloudwatch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>AWS</span><span class=p>.</span><span class=nx>CloudWatch</span><span class=p>()</span>

<span class=nx>exports</span><span class=p>.</span><span class=nx>putMetric</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>unit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>MetricUnit</span><span class=p>.</span><span class=nx>Count</span><span class=p>,</span><span class=w> </span><span class=nx>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=sb>`Creating custom metric </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
<span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>metric</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>buildMetricData</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>unit</span><span class=p>,</span><span class=w> </span><span class=nx>value</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span>
<span class=w>        </span><span class=k>await</span><span class=w> </span><span class=nx>cloudwatch</span><span class=p>.</span><span class=nx>putMetricData</span><span class=p>(</span><span class=nx>metric</span><span class=p>).</span><span class=nx>promise</span><span class=p>()</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span><span class=w> </span><span class=nx>operation</span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>operation</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>operation</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;undefined_operation&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>method</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;putMetric&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>details</span><span class=o>:</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>})</span>
<span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>

<span class=kd>const</span><span class=w> </span><span class=nx>buildMetricData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>unit</span><span class=p>,</span><span class=w> </span><span class=nx>value</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>namespace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;MonitoringApp&#39;</span><span class=p>,</span>
<span class=w>        </span><span class=nx>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SERVICE_NAME</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SERVICE_NAME</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;service_undefined&#39;</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>namespace</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span><span class=nx>namespace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>namespace</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>service</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>service</span>
<span class=w>        </span><span class=ow>delete</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>namespace</span>
<span class=w>        </span><span class=ow>delete</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>service</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>metric</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>MetricData</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>            </span><span class=p>{</span>
<span class=w>                </span><span class=nx>MetricName</span><span class=o>:</span><span class=w> </span><span class=nx>name</span><span class=p>,</span>
<span class=w>                </span><span class=nx>Dimensions</span><span class=o>:</span><span class=w> </span><span class=nx>buildDimensions</span><span class=p>(</span><span class=nx>service</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>),</span>
<span class=w>                </span><span class=nx>Timestamp</span><span class=o>:</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(),</span>
<span class=w>                </span><span class=nx>Unit</span><span class=o>:</span><span class=w> </span><span class=nx>unit</span><span class=p>,</span>
<span class=w>                </span><span class=nx>Value</span><span class=o>:</span><span class=w> </span><span class=nx>value</span>
<span class=w>            </span><span class=p>},</span>
<span class=w>        </span><span class=p>],</span>
<span class=w>        </span><span class=nx>Namespace</span><span class=o>:</span><span class=w> </span><span class=nx>namespace</span>
<span class=w>    </span><span class=p>};</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>metric</span>
<span class=p>}</span>
</code></pre></div> </details> <p>Metrics are in namespace in CloudWatch. </p> <p><img alt src=../images/lambda-metrics.png></p> <p>But those synchronous calls consumes resources and adds latency to the lambda's response. To overcome this overhead, we can adopt an asynchronous strategy to create these metrics. This strategy consists of printing the metrics in a structured or semi-structured format as logs to Amazon CloudWatch Logs and have a mechanism in background processing these entries based on a filter pattern that matches the same entry that was printed.</p> <h3 id=using-the-embedded-metric-format>Using the Embedded Metric Format<a class=headerlink href=#using-the-embedded-metric-format title="Permanent link">&para;</a></h3> <details class=-> <summary>EMF logging code example</summary> <div class=highlight><pre><span></span><code><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>createMetricsLogger</span><span class=p>,</span><span class=w> </span><span class=nx>Unit</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s2>&quot;aws-embedded-metrics&quot;</span><span class=p>)</span>
<span class=nx>exports</span><span class=p>.</span><span class=nx>logMetricEMF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>unit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Unit</span><span class=p>.</span><span class=nx>Count</span><span class=p>,</span><span class=w> </span><span class=nx>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=nx>dimensions</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>metrics</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>createMetricsLogger</span><span class=p>()</span>
<span class=w>        </span><span class=nx>metrics</span><span class=p>.</span><span class=nx>putDimensions</span><span class=p>(</span><span class=nx>buildEMFDimensions</span><span class=p>(</span><span class=nx>dimensions</span><span class=p>))</span>
<span class=w>        </span><span class=nx>metrics</span><span class=p>.</span><span class=nx>putMetric</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>value</span><span class=p>,</span><span class=w> </span><span class=nx>unit</span><span class=p>)</span>
<span class=w>        </span><span class=nx>metrics</span><span class=p>.</span><span class=nx>setNamespace</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AWS_EMF_NAMESPACE</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AWS_EMF_NAMESPACE</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;aws-embedded-metrics&#39;</span><span class=p>)</span>
<span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=sb>`Logging custom metric </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> via Embbeded Metric Format (EMF)`</span><span class=p>)</span>
<span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=nx>metrics</span><span class=p>)</span>
<span class=w>        </span><span class=k>await</span><span class=w> </span><span class=nx>metrics</span><span class=p>.</span><span class=nx>flush</span><span class=p>()</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span><span class=w> </span><span class=nx>operation</span><span class=o>:</span><span class=w> </span><span class=nx>dimensions</span><span class=p>.</span><span class=nx>operation</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>dimensions</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;undefined_operation&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>method</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;logMetricEMF&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>details</span><span class=o>:</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>})</span>
<span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=nx>err</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>

<span class=kd>const</span><span class=w> </span><span class=nx>buildEMFDimensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=nx>dimensions</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=kd>let</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SERVICE_NAME</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SERVICE_NAME</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;service_undefined&#39;</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>dimensions</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>dimensions</span><span class=p>.</span><span class=nx>service</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>dimensions</span><span class=p>.</span><span class=nx>service</span>
<span class=w>        </span><span class=ow>delete</span><span class=w> </span><span class=nx>dimensions</span><span class=p>.</span><span class=nx>namespace</span>
<span class=w>        </span><span class=ow>delete</span><span class=w> </span><span class=nx>dimensions</span><span class=p>.</span><span class=nx>service</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>dimensions</span>
<span class=p>}</span>
</code></pre></div> </details> <h3 id=find-cold-starts>Find cold starts<a class=headerlink href=#find-cold-starts title="Permanent link">&para;</a></h3> <p>Example of cloudwatch insight query:</p> <div class=highlight><pre><span></span><code><span class=n>filter</span><span class=w> </span><span class=o>@</span><span class=k>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ss>&quot;REPORT&quot;</span>
<span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>parse</span><span class=w> </span><span class=o>@</span><span class=n>message</span><span class=w> </span><span class=o>/</span><span class=n>Init</span><span class=w> </span><span class=n>Duration</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=o>?&lt;</span><span class=n>init</span><span class=o>&gt;</span><span class=err>\</span><span class=n>S</span><span class=o>+</span><span class=p>)</span><span class=o>/</span><span class=w> </span>
<span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=k>count</span><span class=p>()</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>total</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>init</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>coldStarts</span><span class=p>,</span><span class=w> </span>
<span class=w>        </span><span class=n>median</span><span class=p>(</span><span class=n>init</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>avgInitDuration</span><span class=p>,</span>
<span class=w>        </span><span class=k>max</span><span class=p>(</span><span class=n>init</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>maxInitDuration</span><span class=p>,</span>
<span class=w>        </span><span class=k>avg</span><span class=p>(</span><span class=o>@</span><span class=n>maxMemoryUsed</span><span class=p>)</span><span class=o>/</span><span class=mi>1000</span><span class=o>/</span><span class=mi>1000</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>memoryused</span>
<span class=k>by</span><span class=w> </span><span class=n>bin</span><span class=p>(</span><span class=mi>5</span><span class=k>min</span><span class=p>)</span>
</code></pre></div> <h2 id=hands-on>Hands-on<a class=headerlink href=#hands-on title="Permanent link">&para;</a></h2> <h3 id=getting-started>Getting Started<a class=headerlink href=#getting-started title="Permanent link">&para;</a></h3> <details class="- info"> <summary>Basic getting started</summary> <p>In a serverless deployment, developer needs to provide all the necessary components: </p> <ul> <li>Code, bundled with any necessary dependencies</li> <li> <p>CloudFormation template: (AWS SAM helps building this CF template).</p> </li> <li> <p>Can start from a blueprint</p> <p><img alt src=../images/lambda-fct-1.png width=800></p> </li> <li> <p>To get the function to upload logs to cloudWatch, select an existing IAM role, or create a new one with the right policy:</p> <p><img alt src=../images/lambda-fct-2.png width=800></p> <p>Here the example of role created</p> <p><img alt src=../images/iam-role-for-lambda.png width=800></p> </li> <li> <p>Add the code as an implementation of an handler function:</p> <p><img alt src=../images/lambda-fct-3.png width=800></p> </li> <li> <p>Create a test event (a request) and run the test and get the resources and logs output.</p> <p><img alt src=../images/lambda-fct-4.png width=800></p> </li> <li> <p>Verify configuration and monitoring in CloudWatch.</p> </li> </ul> </details> <h3 id=python-function-with-dependencies>Python function with dependencies<a class=headerlink href=#python-function-with-dependencies title="Permanent link">&para;</a></h3> <p>It is common to have a function that needs libraries not in the standard Python 3.x environment. The approach is to use a zip file as source of the dependencies. The process to build such zip can be summarized as:</p> <ul> <li><code>lambda</code> is the folder with code and future dependencies. It has a <code>requirements.txt</code> file to define dependencies.</li> <li>do a <code>pip install --target ./python/lib/ -r requirements.txt</code></li> <li> <p>zip the content of the package directory in a zip in the lambda folder</p> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>python
zip<span class=w> </span>-r<span class=w> </span>../lambda-layer.zip<span class=w> </span>.
</code></pre></div> </li> <li> <p>The zip can be used as a <strong>layer</strong>, so reusable between different lambda functions. Upload the zip to a <code>S3</code> bucket and create a layer in the Lambda console, referencing the zip in S3 bucket.</p> <p>As an alternate here is a CDK declaration for the powertool dependencies:</p> <div class=highlight><pre><span></span><code><span class=n>powertools_layer</span> <span class=o>=</span> <span class=n>aws_lambda</span><span class=o>.</span><span class=n>LayerVersion</span><span class=o>.</span><span class=n>from_layer_version_arn</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=nb>id</span><span class=o>=</span><span class=s2>&quot;lambda-powertools&quot;</span><span class=p>,</span>
        <span class=n>layer_version_arn</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;arn:aws:lambda:</span><span class=si>{</span><span class=n>env</span><span class=o>.</span><span class=n>region</span><span class=si>}</span><span class=s2>:017000801446:layer:AWSLambdaPowertoolsPythonV2:61&quot;</span>
    <span class=p>)</span>

<span class=o>...</span>
<span class=n>acm_lambda</span> <span class=o>=</span> <span class=n>aws_lambda</span><span class=o>.</span><span class=n>Function</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;CarMgrService&#39;</span><span class=p>,</span>
        <span class=n>runtime</span><span class=o>=</span><span class=n>aws_lambda</span><span class=o>.</span><span class=n>Runtime</span><span class=o>.</span><span class=n>PYTHON_3_11</span><span class=p>,</span>
        <span class=n>layers</span><span class=o>=</span><span class=p>[</span><span class=n>powertools_layer</span><span class=p>],</span>
        <span class=o>...</span>
</code></pre></div> </li> <li> <p>A layer can be added to any lambda function, then the libraries included in the layer can be imported in the code. Example is the XRay tracing capability in Python.</p> </li> </ul> <details class="- warning"> <summary>project with modules</summary> <p>When the Lambda code is organized with different modules, we may get <code>Unable to import module 'app':...</code> when running the function in the Lambda runtime. Here is an example:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>.acm_model</span> <span class=kn>import</span> <span class=n>AutonomousCar</span><span class=p>,</span> <span class=n>AutonomousCarEvent</span>
</code></pre></div> <p>The folder tree:</p> <div class=highlight><pre><span></span><code>src
├──<span class=w> </span>carmgr
│<span class=w>   </span>├──<span class=w> </span>__init__.py
│<span class=w>   </span>├──<span class=w> </span>acm_model.py
│<span class=w>   </span>└──<span class=w> </span>app.py
└──<span class=w> </span>requirements.txt
</code></pre></div> <p>Add the cdk:</p> <div class=highlight><pre><span></span><code> <span class=n>acm_lambda</span> <span class=o>=</span> <span class=n>aws_lambda</span><span class=o>.</span><span class=n>Function</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;CarMgrService&#39;</span><span class=p>,</span>
                <span class=n>code</span><span class=o>=</span> <span class=n>aws_lambda</span><span class=o>.</span><span class=n>Code</span><span class=o>.</span><span class=n>from_asset</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;../src/&quot;</span><span class=p>,</span>
                <span class=n>handler</span><span class=o>=</span><span class=s1>&#39;carmgr.app.handler&#39;</span><span class=p>,</span>
</code></pre></div> </details> <ul> <li> <p>We can also add the lambda-function code in the zip and modify the existing function, something like:</p> <div class=highlight><pre><span></span><code>zip<span class=w> </span>lambda-layer.zip<span class=w> </span>lambda-handler.py
aws<span class=w> </span>lambda<span class=w> </span>update-function-code<span class=w> </span>--function-name<span class=w>  </span>ApigwLambdaCdkStack-SageMakerMapperLambda2E...C<span class=w> </span>--zip-file<span class=w> </span>file://lambda-layer.zip
</code></pre></div> </li> </ul> <p>See the <a href=https://github.com/jbcodeforce/from-git-to-slack-serverless>the from-git-to-slack-serverless repository</a> for a Lambda example in Python using SAM for deployment and <a href=https://github.com/jbcodeforce/autonomous-car-mgr>autonomous-car-mgr project</a> for cdk based deployment and more module integration.</p> <h3 id=java-based-function>Java based function<a class=headerlink href=#java-based-function title="Permanent link">&para;</a></h3> <p><a href=https://docs.aws.amazon.com/lambda/latest/dg/lambda-java.html>We can run java code in Lambda</a> and implement different <a href=https://docs.aws.amazon.com/lambda/latest/dg/java-handler.html>handlers</a>.</p> <div class=highlight><pre><span></span><code><span class=kn>import</span><span class=w> </span><span class=nn>com.amazonaws.services.lambda.runtime.Context</span><span class=p>;</span>
<span class=kn>import</span><span class=w> </span><span class=nn>com.amazonaws.services.lambda.runtime.RequestHandler</span><span class=p>;</span>

<span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HandlerWeatherData</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>RequestHandler</span><span class=o>&lt;</span><span class=n>WeatherData</span><span class=p>,</span><span class=n>WeatherData</span><span class=o>&gt;</span><span class=p>{</span>

<span class=w>    </span><span class=nd>@Override</span>
<span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>WeatherData</span><span class=w> </span><span class=nf>handleRequest</span><span class=p>(</span><span class=n>WeatherData</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</code></pre></div> <p>Code can be uploaded as jar or zip to a S3 bucket, and CloudFormation template or CDK can define the lambda function.</p> <p>In the Java code template in <a href=https://github.com/jbcodeforce/yarfba/tree/main/labs/lambdas/java-sample>folder</a> the Lambda processes a JavaBean and we can build a docker image, push to ECR and use CDK to deploy the function. </p> <div class=highlight><pre><span></span><code><span class=k>FROM</span><span class=w> </span><span class=s>public.ecr.aws/lambda/java:11</span>
<span class=k>COPY</span><span class=w> </span>target/classes<span class=w> </span><span class=si>${</span><span class=nv>LAMBDA_TASK_ROOT</span><span class=si>}</span>
<span class=k>COPY</span><span class=w> </span>target/dependency/*<span class=w> </span><span class=si>${</span><span class=nv>LAMBDA_TASK_ROOT</span><span class=si>}</span>/lib/
<span class=k>CMD</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&quot;jbcodeforce.HandlerWeatherData::handleRequest&quot;</span><span class=w> </span><span class=p>]</span>
</code></pre></div> <p><a href=https://hub.docker.com/r/amazon/aws-lambda-java>See also the docker image lambda java.</a></p> <p>To be sure the dependencies are used, use the build plugin in maven:</p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
<span class=w>    </span><span class=nt>&lt;artifactId&gt;</span>maven-dependency-plugin<span class=nt>&lt;/artifactId&gt;</span>
<span class=w>    </span><span class=nt>&lt;version&gt;</span>3.1.2<span class=nt>&lt;/version&gt;</span>
<span class=w>       </span>....
</code></pre></div> <p>See the <a href=https://github.com/jbcodeforce/yarfba/tree/main/labs/lambdas/java-sample/README.md>readme for instructions</a>.</p> <p><a href=https://docs.aws.amazon.com/lambda/latest/dg/java-image.html>Product documentation: Deploy Java Lambda functions with container images.</a>.</p> <p>Here is a Lambda Function CDK declaration using ECR image</p> <div class=highlight><pre><span></span><code><span class=n>repository</span><span class=o>=</span> <span class=n>aws_ecr</span><span class=o>.</span><span class=n>Repository</span><span class=o>.</span><span class=n>from_repository_name</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=s2>&quot;java-lambda-ecr-repo&quot;</span><span class=p>,</span><span class=s2>&quot;jbcodeforce/java-lambda&quot;</span><span class=p>)</span>

<span class=n>aws_lambda</span><span class=o>.</span><span class=n>DockerImageFunction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=s2>&quot;JavaLambda&quot;</span><span class=p>,</span>
            <span class=n>code</span><span class=o>=</span><span class=n>aws_lambda</span><span class=o>.</span><span class=n>DockerImageCode</span><span class=o>.</span><span class=n>from_ecr</span><span class=p>(</span><span class=n>repository</span><span class=p>),</span>
            <span class=n>role</span><span class=o>=</span><span class=n>sm_role</span><span class=p>,</span>
            <span class=n>tracing</span><span class=o>=</span><span class=n>aws_lambda</span><span class=o>.</span><span class=n>Tracing</span><span class=o>.</span><span class=n>ACTIVE</span><span class=p>,</span>
             <span class=n>architecture</span><span class=o>=</span><span class=n>aws_lambda</span><span class=o>.</span><span class=n>Architecture</span><span class=o>.</span><span class=n>ARM_64</span><span class=p>)</span>
</code></pre></div> <p><a href=https://catalog.workshops.aws/java-on-aws-lambda/en-US>Java on AWS Lambda workshop </a> to discover best practices for Java and Lambda using GraalVM or SnapStart</p> <h3 id=cicd>CI/CD<a class=headerlink href=#cicd title="Permanent link">&para;</a></h3> <p><a href=https://catalog.us-east-1.prod.workshops.aws/workshops/5195ab7c-5ded-4ee2-a1c5-775300717f42/en-US>Workshop: Building CI/CD pipelines for Lambda canary deployments using AWS CDK</a></p> <h3 id=other-personal-implementations>Other personal implementations<a class=headerlink href=#other-personal-implementations title="Permanent link">&para;</a></h3> <ul> <li><a href=https://github.com/jbcodeforce/yarfba/tree/main/labs/lambdas/lambda-dynamo>Lamdba prepared by SAM + tutorial form AWS Lambda powertool</a> with API gateway.</li> <li><a href=https://github.com/jbcodeforce/yarfba/tree/main/labs/lambdas/s3-lambda>S3 to Lambda to S3 for data transformation</a></li> <li><a href=https://github.com/jbcodeforce/big-data-tenant-analytics/tree/main/setup/apigw-lambda-cdk/lambda>Big data SaaS: lambda to call SageMaker</a></li> <li><a href=https://github.com/jbcodeforce/autonomous-car-mgr.git>cdk python for lambda, dynamoDB, api gtw, AWS powertools (autonomous car manager)</a>: a Python lambda + API gateway, dynamoDB, iam policy, Alias and version.</li> </ul> <h2 id=faqs>FAQs<a class=headerlink href=#faqs title="Permanent link">&para;</a></h2> <ul> <li><a href=https://aws.amazon.com/lambda/faqs/ >The Amazon official FAQs.</a></li> </ul> <h2 id=best-practices>Best practices<a class=headerlink href=#best-practices title="Permanent link">&para;</a></h2> <p>Extracted from <a href=https://broadcast.amazon.com/videos/349995>the Top best practices and tips for building Serverless applications video</a></p> <details class=-> <summary>Be sure to measure concurrency correctly</summary> <p>Concurrency = TPS * Duration. Ex 100 Tx/s for and average duration of 500ms = so concurrency id 50, but is it takes 2s per tx, then c=200. So Optimize for duration &lt;1 and monitor ConcurrentExecutions metric.</p> </details> <details class=-> <summary>Lambda bursting and scaling</summary> <p>Burst limit may differ per region. Each new lambda invocation reuses available execution contexts, and it creates new contexts until the account concurrency limit is reached. So initial burst is subject to the account concurrency limit which may be 1000, but it then scales by +500 contexts per minute until burst limit (3000), once the burst limit is reached, all other requests are throttled. <img alt src=../images/bursting.png width=600></p> </details> <details class=-> <summary>Reuse the execution environment properly</summary> <p>Initialize outside of the handler, lazy load it when needed, and cache static assets in /tmp. In Java the class constructor is only called at cold-start.</p> </details> <details class=-> <summary>Control and limit dependencies</summary> <p>Include only what is needed. In java use the shade maven plugin to create a uber jar which removes duplicates. Use exclusion of jars from aws-sdk. Attach SDK in a layer.</p> </details> <details class=-> <summary>Tell the SDK what to do</summary> <p>Most of the time SDK will know in which region it is, but it costs time, so prefer to use env variables and get in the code. Try to reuse connection. It can reduce CPU utilization up to 50%.</p> </details> <details class=-> <summary>VPC - Lambda</summary> <p>Lambda must target private subnets and never public one. Target two subnets for HA. Do not remove created ENIs in EC2 console. Controls the VPCs, subnets and security groups the Lambda functions can target.</p> </details> <details class=-> <summary>Lambda chaining</summary> <p>Avoid chaining directly lambda functions synchronously. Use Lambda destination or Step Functions.</p> </details> <details class=-> <summary>Inject secrets safely</summary> <p>Inject them in environment variables, where values come in the function yaml definition.</p> </details> <h2 id=more-reading>More reading<a class=headerlink href=#more-reading title="Permanent link">&para;</a></h2> <ul> <li><a href=https://docs.aws.amazon.com/wellarchitected/latest/serverless-applications-lens/welcome.html>Serverless application lens:</a> focus on how to design, deploy, and architect serverless application workloads in the AWS Cloud.</li> <li><a href=https://docs.aws.amazon.com/pdfs/whitepapers/latest/security-overview-aws-lambda/security-overview-aws-lambda.pdf>Security overview of AWS Lambda - whitepaper</a></li> <li><a href=https://docs.aws.amazon.com/lambda/latest/dg/with-s3-example.html>Using an Amazon S3 trigger to invoke a Lambda function</a>.</li> <li> <p><a href=https://aws.amazon.com/blogs/compute/resize-images-on-the-fly-with-amazon-s3-aws-lambda-and-amazon-api-gateway/ >Tutorial: Resize Images on the Fly with Amazon S3, AWS Lambda, and Amazon API Gateway</a>.</p> </li> <li> <p><a href=https://aws.amazon.com/blogs/architecture/best-practices-for-developing-on-aws-lambda/ >Best Practices for Developing on AWS Lambda</a>.</p> </li> <li><a href=https://serverlessrepo.aws.amazon.com/applications/arn:aws:serverlessrepo:us-east-1:451282441545:applications~aws-lambda-power-tuning>Power tuning tool for Lambda.</a></li> <li><a href="https://serverlessland.com/patterns?framework=SAM">Serverless Patterns Collection (Serverlessland)</a>.</li> <li><a href="https://www.youtube.com/playlist?list=PLJV9303TMVKzFk1CNV_bStVZd3ZhW8dNz">Youtube videos - Build on serverless 2019</a>.</li> <li><a href=https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html>Lambda- configuring reserved concurrency</a></li> <li><a href=https://aws.amazon.com/blogs/compute/increasing-real-time-stream-processing-performance-with-amazon-kinesis-data-streams-enhanced-fan-out-and-aws-lambda/ >Increasing real-time stream processing performance with Amazon Kinesis Data Streams enhanced fan-out and AWS Lambda</a></li> <li><a href=https://github.com/awslabs/aws-lambda-powertools-python>Powertool for AWS Lambda - Python</a> a developer toolkit to implement Serverless best practices and increase developer velocity.</li> <li><a href=https://github.com/awslabs/aws-lambda-powertools-java>Powertool for AWS Lambda - Java</a>.</li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../ class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Introduction </div> </div> </a> <a href=../apigtw/ class="md-footer__link md-footer__link--next" aria-label="Next: API Gateway"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> API Gateway </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "navigation.instant", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.af256bd8.min.js></script> </body> </html>